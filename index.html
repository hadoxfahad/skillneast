<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillNeast Courses</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@300;400;600;700&family=Comfortaa:wght@700&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Player Specific CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        :root {
            /* --- NEW: Dark & Genz Style Color Palette --- */
            --primary-dark: #111827;          /* Deep dark blue-gray */
            --secondary-light: #1F2937;       /* Slightly lighter blue-gray */
            --accent-purple: #8B5CF6;         /* Vibrant Purple */
            --accent-pink: #EC4899;           /* Vibrant Pink */
            --accent-teal: var(--accent-purple); /* Legacy mapping to new accent */

            --text-dark: #E5E7EB;             /* Light gray for main text */
            --text-light: #9CA3AF;            /* Medium gray for secondary text */

            --highlight-gold: #FBBF24;        /* Amber/Gold, contrasts well */
            --success-green: #10B981;         /* Emerald Green */
            --error-red: #F43F5E;             /* Rose Red */
            --white: #ffffff;
            
            --border-color: rgba(255, 255, 255, 0.1);
            --cyan-glow-color: rgba(139, 92, 246, 0.5); /* Purple Glow */
            
            --dark-bg-gradient-start: #000000;
            --dark-bg-gradient-end: #111827;
            --card-bg: var(--secondary-light);
            --slider-bg: #111827;
            --slider-item-hover: #1F2937;
            --popup-bg: #1F2937;
            
            --accent-gradient: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
            --success-gradient: linear-gradient(90deg, #10B981, #34D399);

            /* --- Border Radius Variables (Unchanged) --- */
            --border-radius-main: 16px;       /* For large popups, banners */
            --border-radius-card: 12px;       /* For cards, items */
            --border-radius-button: 8px;      /* For standard buttons */
            --border-radius-input: 8px;       /* For inputs */
            --border-radius-pill: 30px;       /* For pill-shaped buttons */
        }

        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            line-height: 1.8;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            padding-bottom: 90px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;

            /* NEW: Subtle Grid Background */
            background-color: var(--primary-dark);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        img {
            pointer-events: none;
            -webkit-user-drag: none;
            user-drag: none;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: auto;
            padding: 0 15px;
        }
        
        /* --- Skeleton UI Loading Overlay (Sci-Fi) --- */
        #skeleton-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: var(--text-dark);
            font-family: 'Montserrat', sans-serif;
            transition: opacity 0.8s ease-out 1s, visibility 0.8s ease-out 1s; /* Add delay for the fade out */
            opacity: 1;
            visibility: visible;
        }
        #skeleton-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        #loader-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 30px;
            border-radius: 50%;
            border: 3px solid var(--accent-purple);
            box-shadow: 0 0 25px var(--cyan-glow-color);
            animation: imagePulse 2s infinite ease-in-out;
        }
        .loading-bar-container {
            width: 80%;
            max-width: 300px;
            height: 10px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: var(--border-radius-pill);
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .loading-bar-fill {
            width: 0;
            height: 100%;
            background: var(--accent-gradient);
            border-radius: var(--border-radius-pill);
            animation: loadingBarAnimation 2.5s ease-in-out forwards;
        }
        #loader-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5em;
            font-weight: 800;
            color: var(--white);
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--cyan-glow-color);
            margin: 0 0 10px 0;
            opacity: 0;
            animation: textFadeInUp 1s ease-out 0.5s forwards;
        }
        #loader-tagline {
            font-family: 'Open Sans', sans-serif;
            font-size: 1.1em;
            color: var(--text-light);
            opacity: 0;
            animation: textFadeInUp 1s ease-out 1s forwards;
        }

        @keyframes loadingBarAnimation {
            from { width: 0%; }
            to { width: 100%; }
        }
        @keyframes imagePulse {
            0% { transform: scale(1); box-shadow: 0 0 25px var(--cyan-glow-color); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px var(--cyan-glow-color); }
            100% { transform: scale(1); box-shadow: 0 0 25px var(--cyan-glow-color); }
        }
        @keyframes textFadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* --- End of Skeleton UI --- */


        /* --- Access Lock Overlay (REDESIGNED & SCROLLABLE) --- */
        #access-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 20, 0.9);
            backdrop-filter: blur(12px);
            display: none; /* Initially hidden */
            justify-content: center; /* Horizontal centering */
            align-items: center; /* Vertical centering */
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* Make overlay scrollable */
        }
        .access-popup {
            background: linear-gradient(145deg, var(--secondary-light), var(--primary-dark));
            padding: 30px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 0 25px var(--cyan-glow-color), 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--accent-purple);
            animation: fadeInSlideUp 0.6s ease-out forwards;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: auto; /* Helps with centering in scrollable view */
        }
        .access-popup .icon-lock {
            font-size: 3.5rem;
            color: var(--accent-purple);
            margin-bottom: 0;
        }
        .access-popup h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0;
        }

        /* Instructions Section */
        .access-instructions {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-card);
            padding: 20px;
            text-align: left;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .access-instructions .step {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .access-instructions .step-number {
            background: var(--accent-gradient);
            color: var(--white);
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1em;
        }
        .access-instructions p {
            font-size: 0.95em;
            color: var(--text-light);
            margin: 0;
            line-height: 1.6;
        }

        /* Generate Key Button */
        .generate-key-btn {
            background: var(--accent-gradient);
            color: var(--white);
            padding: 15px;
            border-radius: var(--border-radius-pill);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            border: none;
        }
        .generate-key-btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }
        
        /* Separator */
        .separator {
            width: 100%;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            line-height: 0.1em;
            margin: 5px 0 15px;
        }
        .separator span {
            background: var(--secondary-light);
            padding: 0 10px;
            color: var(--text-light);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
        }

        /* Input and Unlock Area */
        .unlock-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .access-popup #key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-input);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            font-weight: 600;
            text-align: center;
            letter-spacing: 2px;
            color: var(--text-dark);
            background-color: #2a2a2a;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            text-transform: uppercase;
            box-sizing: border-box;
            margin: 0;
        }
        .access-popup #key-input:focus {
            border-color: var(--accent-purple);
            box-shadow: 0 0 10px var(--cyan-glow-color);
        }
        .access-popup #unlock-button {
            width: 100%;
            background: var(--success-gradient);
            color: white;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius-button);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .access-popup #unlock-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .access-popup #unlock-button:active {
            transform: scale(0.98);
        }
        .access-popup #error-message {
            color: var(--error-red);
            font-weight: 600;
            min-height: 20px;
            margin-top: -10px; /* Adjust position */
        }
        /* --- End of Access Lock Redesign --- */


        /* --- Key Success Popup --- */
        #key-success-popup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(10, 20, 30, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001; /* Above lock screen */
            padding: 20px;
            box-sizing: border-box;
        }
        .key-success-popup {
            background-color: var(--primary-dark);
            padding: 40px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 0 20px var(--cyan-glow-color), var(--shadow-popup);
            text-align: center;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--accent-purple);
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }
        .key-success-popup .icon-container {
            width: 80px;
            height: 80px;
            background: var(--success-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .key-success-popup .icon-container i {
            font-size: 2.5rem;
            color: white;
        }
        .key-success-popup h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6em;
            color: var(--text-dark);
            margin-bottom: 15px;
        }
        .key-success-popup p {
            font-size: 1em;
            color: var(--text-light);
            margin-bottom: 30px;
        }
        .key-success-popup .success-action-btn {
            width: 100%;
            background: var(--accent-gradient);
            color: white;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius-pill);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
        }
        .key-success-popup .success-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
         .key-success-popup .success-action-btn:active {
            transform: scale(0.98);
        }

        /* --- Welcome Popup (Top Aligned) --- */
        .popup-welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed to flex-start for top alignment */
            z-index: 2100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding-top: 5vh; /* Added padding to push content from the top edge */
            overflow-y: auto; /* Allow scrolling if content overflows */
            box-sizing: border-box;
        }
        .popup-welcome-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .popup-welcome-content {
            background: var(--secondary-light);
            border-radius: var(--border-radius-card);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 400px;
            text-align: center;
            padding: 0;
            position: relative;
            transform: scale(0.85);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            overflow: hidden;
            margin-bottom: 5vh; /* Add margin at the bottom for scroll spacing */
        }
        .popup-welcome-overlay.active .popup-welcome-content {
            transform: scale(1);
            opacity: 1;
        }
        .popup-welcome-content .popup-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.3);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 1.2em;
            line-height: 1;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .popup-welcome-content .popup-close-btn:hover {
            background-color: rgba(0,0,0,0.5);
            transform: rotate(90deg);
        }
        .popup-welcome-content .popup-header-image {
            width: 100%;
            height: 150px;
            object-fit: cover; /* Changed to cover */
            background-color: var(--accent-purple); /* Or any fallback color */
            display: block; /* Ensure it takes up space even if img src is empty */
        }
        /* Fallback for image errors or missing image */
        .popup-welcome-content .popup-header-image.error-fallback {
            text-align: center;
            line-height: 150px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: white;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup-welcome-content .popup-header-image.error-fallback::before {
            content: "SkillNeast"; /* Text to show when image fails */
        }


        .popup-welcome-content .popup-main-content {
            padding: 25px;
            padding-top: 15px; /* Adjusted padding */
        }
        .popup-welcome-content h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6em;
            font-weight: 700;
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .popup-welcome-content p {
            font-size: 1em;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .popup-welcome-content .popup-features-list {
            list-style: none;
            padding: 0;
            margin: 0 0 25px 0;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .popup-welcome-content .popup-features-list li {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
        }
        .popup-welcome-content .popup-features-list i {
            color: var(--success-green);
        }
        .popup-welcome-content .popup-button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .popup-welcome-content .popup-btn {
            padding: 12px 20px;
            border-radius: var(--border-radius-button);
            border: none;
            font-size: 1em;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            text-decoration: none;
            display: block;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .popup-welcome-content .popup-btn.primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px var(--cyan-glow-color);
        }
        .popup-welcome-content .popup-btn.secondary {
            background: transparent;
            color: var(--text-light);
            border: 2px solid var(--border-color);
            background-color: #444; /* Grey background for Cancel */
            box-shadow: none; /* No extra shadow for secondary */
        }
        .popup-welcome-content .popup-btn.secondary:hover {
            background-color: #555;
        }
        .popup-welcome-content .popup-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .popup-btn::before {
             content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }
        .popup-btn:hover::before {
            left: 100%;
        }


        /* NEW: Glassmorphism Top Navbar */
        .top-navbar {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            align-items: center;
            padding: 18px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: transform 0.3s ease;

            /* Glassmorphism Effect */
            background-color: rgba(31, 41, 55, 0.5); /* Semi-transparent background */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .top-navbar.hidden {
            transform: translateY(-100%);
        }
        .top-navbar .menu-icon, .top-navbar .notification-icon-wrapper {
            font-size: 1.8em;
            color: var(--white);
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            position: relative; /* For the badge */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .top-navbar .menu-icon { justify-self: start; }
        .top-navbar .notification-icon-wrapper { justify-self: end; }


        .top-navbar .menu-icon:hover, .top-navbar .notification-icon-wrapper:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-pink);
            color: var(--white);
            font-size: 0.6em;
            font-weight: 700;
            border-radius: 50%;
            padding: 4px 7px;
            min-width: 20px;
            text-align: center;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: none; /* Hidden by default */
        }
        .notification-badge.active {
            display: block;
        }

        .top-navbar .app-logo {
            justify-self: center;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            padding: 8px 18px;
            background-color: var(--primary-dark);
            border-radius: var(--border-radius-pill);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .top-navbar .app-logo:hover {
            background-color: var(--secondary-light);
        }
        .top-navbar .app-logo img#skillNeastLogo {
            height: clamp(30px, 5vw, 34px);
            margin-bottom: 0;
            transition: transform 1s linear;
        }
        .top-navbar .app-logo img#skillNeastLogo.rotating {
            animation: rotate360 1s linear forwards;
        }
        @keyframes rotate360 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .top-navbar .app-logo .text-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .top-navbar .app-logo .main-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: clamp(1.3em, 4vw, 1.6em);
            letter-spacing: 1.2px;
            background: linear-gradient(90deg, #FF6F61, #FBBF24, #10B981, #8B5CF6, #EC4899, #9C27B0);
            -webkit-background-clip: text;
            color: transparent;
            display: inline-block;
            animation: rainbowText 5s linear infinite, glowEffect 2.5s ease-in-out infinite alternate;
            background-size: 200% 100%;
            line-height: 1;
        }

        @keyframes rainbowText {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        @keyframes glowEffect {
            from {
                text-shadow: 0 0 4px rgba(255, 255, 255, 0.4), 0 0 8px var(--accent-purple), 0 0 12px var(--accent-purple);
            }
            to {
                text-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 16px var(--highlight-gold), 0 0 24px var(--highlight-gold);
            }
        }
        .top-navbar .app-logo .tagline {
            font-family: 'Open Sans', sans-serif;
            font-size: clamp(0.6em, 2vw, 0.7em);
            font-weight: 600;
            color: var(--text-light);
            text-align: center;
            animation: floatUpDown 2s infinite ease-in-out;
            white-space: nowrap;
            line-height: 1;
        }

        /* --- Main Content Area --- */
        .main-content {
            padding: 30px 20px;
            min-height: calc(100vh - 180px);
        }
        body.fullscreen .main-content {
            padding: 0;
            height: 100vh;
        }

        /* --- NEW: BATCH PROGRESS BAR --- */
        #batch-progress-bar-container {
            background-color: var(--card-bg);
            padding: 15px 20px;
            border-bottom-left-radius: var(--border-radius-card);
            border-bottom-right-radius: var(--border-radius-card);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: sticky;
            top: 90px; /* Height of top navbar */
            z-index: 999;
            margin: -20px 0 20px 0;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 15px;
        }
        #progress-bar-title {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            color: var(--text-dark);
            white-space: nowrap;
        }
        .progress-bar {
            flex-grow: 1;
            height: 12px;
            background-color: var(--primary-dark);
            border-radius: var(--border-radius-pill);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: var(--accent-gradient);
            border-radius: var(--border-radius-pill);
            transition: width 0.5s ease-in-out;
        }
        #progress-bar-percentage {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: var(--accent-purple);
            font-size: 1.1em;
        }


        /* --- Welcome Banner --- */
        .welcome-banner {
            background: linear-gradient(135deg, var(--secondary-light), var(--primary-dark));
            color: var(--text-dark);
            padding: 28px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 0 20px var(--cyan-glow-color), 0 10px 30px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .welcome-banner .greeting {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.9em;
            font-weight: 700;
            display: flex;
            align-items: center;
            color: var(--text-dark);
        }
        .welcome-banner .greeting i {
            margin-right: 10px;
            color: var(--error-red);
            font-size: 1.5em;
            vertical-align: middle;
        }
        .welcome-banner .fire-icon {
            font-size: 2.5em;
            color: var(--accent-pink);
            animation: pulse 1s infinite alternate;
            vertical-align: middle;
            margin-left: 0;
        }
        .role-sticker {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-gradient);
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.7em;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: var(--border-radius-pill);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- Quote Section --- */
        .quote-section {
            background: linear-gradient(135deg, var(--secondary-light), var(--primary-dark));
            padding: 30px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 0 15px var(--cyan-glow-color),
                        0 10px 30px rgba(0, 0, 0, 0.35);
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid var(--accent-purple);
            position: relative;
            overflow: hidden;
        }
        .quote-section::before {
            content: '“';
            position: absolute;
            top: 10px;
            left: 20px;
            font-family: serif;
            font-size: 5em;
            color: rgba(139, 92, 246, 0.1);
            z-index: 0;
            line-height: 0.5;
        }
        .quote-section::after {
            content: '”';
            position: absolute;
            bottom: -20px;
            right: 20px;
            font-family: serif;
            font-size: 5em;
            color: rgba(139, 92, 246, 0.1);
            z-index: 0;
            line-height: 0.5;
        }
        .quote-section .quote-text {
            font-family: 'Open Sans', sans-serif;
            font-style: italic;
            font-size: 1.25em;
            margin-bottom: 18px;
            color: var(--text-dark);
            position: relative;
            z-index: 1;
            animation: quoteSlideIn 0.8s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            padding: 0 10px;
        }
        @keyframes quoteSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quote-section .quote-author {
            font-weight: 700;
            color: var(--highlight-gold);
            font-size: 1.1em;
            position: relative;
            z-index: 1;
            animation: quoteAuthorFadeIn 1s ease-out forwards;
        }
        @keyframes quoteAuthorFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .quote-section .quote-emoji {
            font-size: 1.3em;
            margin-left: 10px;
            display: inline-block;
            z-index: 1;
            animation: emojiPopAndGlow 0.6s ease-out forwards, floatUpDown 2s infinite ease-in-out;
        }
        @keyframes emojiPopAndGlow {
            0% { transform: scale(0); opacity: 0; text-shadow: none; }
            50% { transform: scale(1.3); opacity: 1; text-shadow: 0 0 8px var(--cyan-glow-color); }
            100% { transform: scale(1); opacity: 1; text-shadow: none; }
        }
        @keyframes floatUpDown {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        /* --- Homepage Info Cards --- */
        .info-cards-wrapper {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Telegram Channels Banner (WE NEED) - Premium Look */
        .telegram-channels-banner {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: var(--border-radius-main);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            padding: 25px;
            text-align: center;
            color: #333;
            font-family: 'Montserrat', sans-serif;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        .telegram-channels-banner::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            filter: blur(15px);
        }
        .telegram-channels-banner::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: -10px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            filter: blur(20px);
        }

        .telegram-channels-banner .banner-title {
            font-size: 1.8em;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #C0392B;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            z-index: 1;
        }
        .telegram-channels-banner h2 {
            font-size: 1.5em;
            font-weight: 700;
            color: #4A4A4A;
            margin: 0;
            line-height: 1.2;
            z-index: 1;
        }
        .telegram-channels-banner .channel-list {
            text-align: center;
            font-size: 1em;
            font-weight: 600;
            line-height: 2;
            color: #666;
            z-index: 1;
        }
        .telegram-channels-banner .channel-list span {
            display: block;
            margin-bottom: 5px;
        }
        .telegram-channels-banner .channel-list i {
            margin-right: 8px;
            color: #007bff;
        }
        .telegram-channels-banner .click-here-button {
            background-color: #007bff;
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: var(--border-radius-pill);
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1;
        }
        .telegram-channels-banner .click-here-button:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
        }
        .telegram-channels-banner .your-support-text {
            font-size: 1.2em;
            font-weight: 700;
            color: #C0392B;
            margin-top: 15px;
            z-index: 1;
        }

        /* Discover Notice (Namo Buddhaya Everyone) - Premium Look */
        .discover-notice {
            background: linear-gradient(135deg, var(--secondary-light), #000000);
            border-radius: var(--border-radius-main);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            padding: 30px;
            color: var(--text-dark);
            font-family: 'Open Sans', sans-serif;
            text-align: left;
            display: none;
            position: relative;
            border: 1px solid var(--border-color);
        }
        .discover-notice .discover-image {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-card);
            margin-bottom: 20px;
        }
        .discover-notice h4 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--highlight-gold);
            margin-bottom: 15px;
            text-align: center;
            line-height: 1.4;
        }
        .discover-notice ol {
            padding-left: 20px;
            margin-bottom: 0;
            color: var(--text-light);
        }
        .discover-notice ol li {
            margin-bottom: 10px;
            font-size: 1em;
            line-height: 1.6;
        }
        .discover-notice .emoji-inline {
            margin-right: 8px;
            font-size: 1.1em;
        }
        /* Discover Notice Reactions */
        .discover-notice-reactions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .discover-notice-reactions .reaction-icon-discover {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: var(--border-radius-button);
            transition: background-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
            user-select: none;
            display: flex;
            align-items: center;
            color: var(--text-light);
        }
        .discover-notice-reactions .reaction-icon-discover .reaction-count {
            font-size: 0.85em;
            margin-left: 6px;
            color: var(--text-light);
            font-family: 'Montserrat', sans-serif;
        }
        .discover-notice-reactions .reaction-icon-discover:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        .discover-notice-reactions .reaction-icon-discover.reacted {
            background-color: rgba(139, 92, 246, 0.3);
            color: var(--accent-purple);
            transform: scale(1.05);
        }
        .discover-notice-reactions .reaction-emoji {
            font-size: 1.3em;
            line-height: 1;
        }


        /* --- Home View --- */
        #home-view {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        #course-categories-grid {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: 20px;
        }
        
        /* MODIFIED: 3D Hover Effect on Cards (Increased Effect) */
        .course-category-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 0;
            text-align: center;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: stretch;
            min-height: 180px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            width: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease, border-color 0.4s ease;
        }
        .course-category-item:hover {
            transform: perspective(1000px) translateY(-8px) rotateY(-5deg);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4), 0 0 20px var(--cyan-glow-color);
            border-color: var(--accent-purple);
        }
        .course-category-item .image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: inherit;
            overflow: hidden;
            z-index: 1;
        }
        .course-category-item .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            padding: 10px;
            box-sizing: border-box;
        }
        /* MODIFIED: Shortened Glassmorphism effect */
        .course-category-item .content-overlay {
            position: relative;
            z-index: 2;
            background: linear-gradient(0deg, rgba(17, 24, 39, 0.9) 0%, rgba(31, 41, 55, 0.7) 20%, rgba(0,0,0,0) 35%);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px); /* Glassmorphism effect */
            color: var(--white);
            padding: 20px 15px 10px 15px;
            text-align: center;
            box-sizing: border-box;
            width: 100%;
            margin-top: auto;
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Subtle top border for glass effect */
        }
        .course-category-item .content-overlay .category-name {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1.2em;
            line-height: 1.2;
            margin-bottom: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }
        
        /* --- NEW: FAVORITES CARD REVAMPED --- */
        .favorites-section-home-card {
            background: linear-gradient(135deg, #6D28D9, #EC4899);
            border-radius: var(--border-radius-main);
            padding: 30px 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: var(--white);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--accent-pink);
        }
        .favorites-section-home-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 0 15px 35px var(--cyan-glow-color);
        }
        .favorites-section-home-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s ease-in-out;
        }
        .favorites-section-home-card:hover::before {
            left: 150%;
        }
        .favorites-section-home-card h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 15px;
            text-shadow: 1px 1px 5px rgba(0,0,0,0.3);
        }
        .favorites-section-home-card .fav-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            color: var(--white);
            text-shadow: 0 0 15px rgba(255,255,255,0.5);
            animation: heartbeat 1.5s infinite ease-in-out;
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        .favorites-section-home-card p {
            font-size: 1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .favorites-section-home-card .fav-count {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            background-color: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: var(--border-radius-pill);
        }

        .telegram-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease, border-color 0.4s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            border: 1px solid var(--border-color);
            color: var(--text-dark);
        }
        .telegram-card:hover {
            transform: perspective(1000px) translateY(-8px) rotateY(5deg);
            box-shadow: 0 15px 30px rgba(0, 136, 204, 0.4);
            border-color: #0088cc;
        }
        .telegram-card .telegram-icon-large {
            font-size: 3em;
            color: #0088cc;
            margin-bottom: 10px;
        }
        .telegram-card .telegram-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.2em;
            color: var(--text-dark);
        }

        /* --- NEW: Home Actions Button Grid --- */
        .home-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            grid-auto-rows: 1fr; /* Ensures cards in a row have same height */
        }
        .home-action-btn {
            background: var(--card-bg);
            color: var(--text-dark);
            padding: 20px;
            border-radius: var(--border-radius-card);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        .home-action-btn:hover {
            transform: perspective(1000px) translateY(-8px) rotateY(-3deg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }
        .home-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.7s ease-in-out;
        }
        .home-action-btn:hover::before {
            left: 150%;
        }
        .home-action-btn i {
            font-size: 2.5em; /* Increased icon size */
            margin-bottom: 15px;
            color: var(--accent-purple);
            animation: floatUpDown 2.5s infinite ease-in-out; /* Added animation */
            text-shadow: 0 0 15px currentColor; /* Added glow */
        }
        /* Specific icon colors for variety */
        .home-action-btn.surprise i { color: var(--accent-pink); }
        .home-action-btn.request i { color: #007bff; }
        .home-action-btn.share i { color: var(--success-green); }
        .home-action-btn.timer i { color: var(--highlight-gold); }
        
        .action-btn-text h4 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 700;
            margin: 0 0 5px 0;
            color: var(--text-dark);
        }
        .action-btn-text p {
            font-size: 0.8em;
            color: var(--text-light);
            line-height: 1.4;
            margin: 0;
        }
        @media (min-width: 992px) {
            #course-categories-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 25px;
            }
            .home-actions-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 768px) and (max-width: 991px) {
            #course-categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 992px) {
            .info-cards-wrapper {
                flex-direction: row;
                align-items: stretch;
            }
            .info-cards-wrapper > div {
                flex: 1;
                margin-bottom: 0; 
                display: flex !important;
                flex-direction: column;
            }
            .discover-notice {
                justify-content: space-between;
            }
        }
        @media (max-width: 768px) {
             .top-navbar { 
                padding: 12px 15px; 
                grid-template-columns: 50px 1fr 50px;
            }
            .top-navbar .menu-icon, .top-navbar .notification-icon-wrapper {
                width: 44px;
                height: 44px;
                font-size: 1.6em;
            }
            .top-navbar .app-logo {
                padding: 5px 10px;
                gap: 8px;
            }
        }
        @media (max-width: 600px) {
            #course-categories-grid, .home-actions-grid {
                grid-template-columns: 1fr;
            }
            .course-category-item {
                min-height: 160px;
            }
            .course-category-item .content-overlay .category-name { font-size: 0.95em;}
        }

        /* Responsive Batch List */
        .batch-list {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr; /* Default mobile view */
        }
        @media (min-width: 768px) {
            .batch-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1200px) {
            .batch-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }


        #new-batches-view {
            display: none;
            padding: 0px;
        }
        /* Adjusted for consistency with other headers */
        #new-batches-view .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        #new-batches-view .back-button {
            background-color: transparent;
            border: none;
            font-size: 2em;
            color: var(--text-dark);
            cursor: pointer;
            margin-right: 18px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #new-batches-view .back-button:hover {
            color: var(--accent-purple);
            transform: translateX(-5px);
        }
        #new-batches-view h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em; /* Consistent size */
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            flex-grow: 1;
        }
        .search-bar-container {
            display: flex;
            align-items: center;
            background-color: var(--secondary-light);
            border-radius: var(--border-radius-pill);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            padding: 8px 15px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .search-bar-container input {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 8px 10px;
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            color: var(--text-dark);
            background-color: transparent;
        }
        .search-bar-container .search-icon {
            font-size: 1.2em;
            color: var(--text-light);
            margin-right: 10px;
        }
        .search-bar-container .search-button {
            background: var(--accent-gradient);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-pill);
            padding: 10px 20px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s;
        }
        .search-bar-container .search-button:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 10px var(--cyan-glow-color);
        }
        
        .batch-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-card);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease;
            position: relative; /* Needed for tag positioning */
        }
        /* MODIFIED: Increased tilt */
        .batch-card:hover {
            transform: perspective(1000px) translateY(-10px) rotateY(-4deg);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5), 0 0 25px var(--cyan-glow-color);
        }
        .batch-card-header {
            position: relative;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 600;
        }
        .batch-card-header .batch-title-text {
            flex-grow: 1;
        }
        .batch-card-header .icons {
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .batch-card-header .icons i {
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .batch-card-header .icons i.fas.fa-heart {
            color: var(--error-red);
            transform: scale(1.1);
        }
        .batch-card-header .icons i:hover {
            transform: scale(1.2);
        }

        .batch-card-body {
            padding: 20px;
        }
        .batch-card-body .batch-image-container {
            width: calc(100% + 40px);
            aspect-ratio: 16 / 9; /* MODIFIED: Set aspect ratio */
            margin: -20px -20px 15px -20px;
            border-radius: 0;
            overflow: hidden;
            position: relative;
        }
        .batch-card-body .batch-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .batch-card-body .batch-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.6em;
            font-weight: 700;
            color: var(--text-dark);
            margin-top: 0;
            margin-bottom: 10px;
        }
        .batch-price {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.3em;
            font-weight: 700;
            color: var(--accent-purple);
            margin-bottom: 15px;
        }
        .batch-price.paid {
            color: var(--highlight-gold);
        }

        .batch-description-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: var(--text-light);
            font-size: 0.95em;
        }
        .batch-description-item {
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeInCheck 0.5s ease-out forwards;
            opacity: 0;
        }
        .batch-description-item i {
            color: var(--success-green);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes fadeInCheck {
            to { opacity: 1; }
        }
        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        .batch-card-body .lets-roar-button {
            background: var(--accent-gradient);
            color: var(--white);
            padding: 15px 25px;
            border-radius: var(--border-radius-pill);
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-top: 20px;
            border: none;
        }
        .batch-card-body .lets-roar-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--cyan-glow-color);
        }
        .batch-card-body .lets-roar-button i {
            font-size: 1.2em;
        }

        /* Batch Tag Styles */
        .batch-card-header .type-tag {
            background-color: var(--accent-purple);
            color: var(--white);
            font-size: 0.75em;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: var(--border-radius-pill);
            text-transform: uppercase;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .batch-card-header .type-tag.paid {
            background-color: var(--highlight-gold);
            color: var(--primary-dark);
        }
        .batch-card-header .type-tag.free {
            background-color: var(--success-green);
        }

        .batch-image-container .status-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--accent-pink);
            color: var(--white);
            font-size: 0.75em;
            font-weight: 700;
            padding: 5px 10px;
            border-radius: var(--border-radius-pill);
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 2;
        }
        .batch-image-container .status-tag.old {
            background-color: #6c757d;
        }

        /* NEW: Language Tag style */
        .batch-image-container .language-tag {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--accent-purple);
            color: var(--white);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8em;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: var(--border-radius-button);
            z-index: 2;
            text-shadow: 1px 1px 2px #000;
            backdrop-filter: blur(2px);
        }

        /* --- SKELETON LOADER FOR BATCH CARDS (NEW) --- */
        .skeleton-batch-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-card);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .skeleton-placeholder {
            background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: var(--border-radius-input);
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-batch-card .skeleton-header {
            height: 50px; /* Same as batch-card-header padding */
            padding: 15px 20px;
            background-color: #374151;
        }

        .skeleton-batch-card .skeleton-body {
            padding: 20px;
        }
        .skeleton-batch-card .skeleton-image {
            width: 100%;
            aspect-ratio: 16/9; /* MODIFIED: Set aspect ratio for skeleton too */
            margin-bottom: 15px;
            border-radius: 0;
        }
        .skeleton-batch-card .skeleton-title {
            width: 70%;
            height: 28px;
            margin-bottom: 15px;
        }
        .skeleton-batch-card .skeleton-price {
            width: 30%;
            height: 24px;
            margin-bottom: 15px;
        }
        .skeleton-batch-card .skeleton-desc-line {
            width: 100%;
            height: 16px;
            margin-bottom: 8px;
        }
        .skeleton-batch-card .skeleton-desc-line.short {
            width: 80%;
        }
        .skeleton-batch-card .skeleton-button {
            width: 100%;
            height: 50px;
            margin-top: 20px;
            border-radius: var(--border-radius-pill);
        }
        /* --- END SKELETON LOADER CSS --- */


        #favorites-view {
            display: none;
            padding: 0px;
        }
        #favorites-view .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        #favorites-view .back-button {
            background-color: transparent;
            border: none;
            font-size: 2em;
            color: var(--text-dark);
            cursor: pointer;
            margin-right: 18px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #favorites-view .back-button:hover {
            color: var(--accent-purple);
            transform: translateX(-5px);
        }
        #favorites-view h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            flex-grow: 1;
        }
        .no-favorites-message-view {
            font-size: 1.2em;
            color: var(--text-light);
            text-align: center;
            padding: 40px 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        #sections-view, #notifications-view, #request-courses-view, #timer-view, #player-view {
            display: none;
            padding: 20px;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-dark);
            z-index: 1200;
            overflow-y: auto;
        }
        #sections-view .section-header, #notifications-view .section-header, #request-courses-view .section-header, #timer-view .section-header, #player-view .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }
        #sections-view .back-button, #notifications-view .back-button, #request-courses-view .back-button, #timer-view .back-button, #player-view .back-button {
            background-color: transparent;
            border: none;
            font-size: 2em;
            color: var(--text-dark);
            cursor: pointer;
            margin-right: 18px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #sections-view .back-button:hover, #notifications-view .back-button:hover, #request-courses-view .back-button:hover, #timer-view .back-button:hover, #player-view .back-button:hover {
            color: var(--accent-purple);
            transform: translateX(-5px);
        }
        #sections-view h2, #notifications-view h2, #request-courses-view h2, #timer-view h2, #player-view h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            flex-grow: 1;
        }

        /* --- Timer View Specific Styles --- */
        #timer-view .timer-container {
            background: linear-gradient(135deg, var(--secondary-light), var(--primary-dark));
            padding: 40px 20px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 0 20px var(--cyan-glow-color), 0 5px 20px rgba(0,0,0,0.3);
            text-align: center;
        }
        #timer-view .timer-message {
            font-size: 1.2em;
            color: var(--text-light);
            margin-bottom: 30px;
            font-weight: 600;
        }
        #timer-view .timer-display {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        #timer-view .timer-box {
            background-color: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: var(--border-radius-card);
            border: 1px solid var(--border-color);
        }
        #timer-view .timer-value {
            font-family: 'Montserrat', sans-serif;
            font-size: 3.5em;
            font-weight: 800;
            color: var(--white);
            line-height: 1;
        }
        #timer-view .timer-label {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 5px;
            text-transform: uppercase;
        }

        .sections-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Notifications View specific styles */
        #notifications-view .tab-buttons {
            margin-bottom: 15px;
        }
        #notifications-view .tab-button {
            padding: 12px 0px;
        }
        #notifications-view .section-header {
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        #notifications-view .mark-all-read-btn {
            background-color: rgba(139, 92, 246, 0.2);
            color: var(--accent-purple);
            border: 1px solid var(--accent-purple);
            padding: 8px 15px;
            border-radius: var(--border-radius-button);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, color 0.2s;
        }
        #notifications-view .mark-all-read-btn:hover {
            background-color: var(--accent-purple);
            color: var(--white);
            transform: translateY(-2px);
        }

        .notification-item {
            background-color: var(--secondary-light);
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-purple);
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            transition: background-color 0.2s ease, transform 0.2s ease;
            position: relative;
        }
        .notification-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .notification-item.is-read {
            background-color: var(--primary-dark);
            border-left-color: var(--text-light);
            opacity: 0.8;
        }
        .notification-item .notification-item-icon {
            font-size: 2em;
            color: var(--accent-purple);
            flex-shrink: 0;
            margin-top: 5px; /* Align icon with text */
        }
        .notification-item.is-read .notification-item-icon {
            color: var(--text-light);
        }
        .notification-item .notification-content {
            flex-grow: 1;
        }
        .notification-item .notification-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0 0 5px 0;
        }
        .notification-item.is-read .notification-title {
            color: var(--text-light);
        }
        .notification-item .notification-text {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .notification-item .notification-timestamp {
            font-size: 0.75em;
            color: var(--text-light);
            opacity: 0.7;
            margin-top: 5px;
        }
        .notification-item .notification-button-wrapper {
            margin-top: 10px;
        }
        .notification-item .notification-button {
            background-color: var(--accent-purple);
            color: var(--white);
            padding: 8px 15px;
            border-radius: var(--border-radius-button);
            font-size: 0.8em;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease, transform 0.2s ease;
            display: inline-block;
        }
        .notification-item .notification-button:hover {
            background-color: var(--accent-pink);
            transform: translateY(-2px);
        }
        .notification-item .notification-thumbnail {
            width: 80px;
            height: 60px;
            border-radius: var(--border-radius-input);
            object-fit: cover;
            flex-shrink: 0;
            margin-right: 15px;
            background-color: #1A1A1A; /* Fallback background */
        }


        /* Request Courses View Styles */
        .request-list-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .request-card {
            background-color: var(--secondary-light);
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 0; /* Remove padding here, add to body instead */
            border: 1px solid var(--border-color);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease, border-color 0.4s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Important for image border-radius */
        }
        /* MODIFIED: Increased tilt */
        .request-card:hover {
            transform: perspective(1000px) translateY(-10px) rotateY(-4deg);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5), 0 0 25px var(--cyan-glow-color);
            border-color: var(--accent-purple);
        }

        .request-image-container { /* New container for the large image */
            width: 100%;
            aspect-ratio: 16 / 9; /* MODIFIED: Set aspect ratio */
            overflow: hidden;
            position: relative;
        }
        .request-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            cursor: pointer; /* Image is clickable */
        }
        .request-image-container img.error-fallback {
            background-color: var(--accent-purple);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .request-card-body { /* New wrapper for text content */
            padding: 20px; /* Add padding here */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .request-card-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }
        .request-card-description {
            font-size: 0.95em;
            color: var(--text-light);
            line-height: 1.5;
            margin-bottom: 0; /* Remove default margin */
        }
        .request-features-list {
            list-style: none;
            padding: 0;
            margin: 0; /* Remove default margin */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .request-features-list li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.9em;
            color: var(--text-light);
        }
        .request-features-list i {
            color: var(--success-green);
            font-size: 1.1em;
            flex-shrink: 0; /* Prevent icon from shrinking */
        }

        .request-card-actions {
            display: flex;
            flex-direction: column; /* Changed to column for stacking */
            align-items: flex-start; /* Align contents to the left */
            gap: 10px; /* Space between button and reactions */
            margin-top: 10px;
            padding-top: 15px; /* Add padding for separator effect */
            border-top: 1px solid var(--border-color);
        }
        .request-card-actions .request-button { /* Now within actions, so select it specifically */
            background: var(--accent-gradient);
            color: var(--white);
            padding: 10px 20px;
            border-radius: var(--border-radius-button);
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9em;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
        }
        .request-card-actions .request-button:hover { /* Target specific button */
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--cyan-glow-color);
        }
        /* Make reactions align left too */
        .request-card-actions .request-reactions-container {
            width: 100%; /* Ensure it takes full width for flex-start to work */
            justify-content: flex-start; /* Align reactions to the left */
        }


        .section-item {
            background: var(--popup-bg);
            border-left: 4px solid var(--accent-purple);
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease;
        }
        /* MODIFIED: Increased tilt */
        .section-item:hover {
            transform: perspective(1000px) translateY(-8px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .section-item .section-name {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0 0 15px 0;
        }

        .section-item .section-counts {
            display: flex;
            flex-wrap: wrap; /* NEW */
            gap: 15px; /* ADJUSTED */
            font-family: 'Open Sans', sans-serif;
            font-size: 0.9em;
            color: var(--text-light);
        }

        .section-item .section-counts span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-item .section-counts i {
            color: var(--accent-purple);
        }
        /* NEW: Folder Count Color */
        .section-item .section-counts i.fa-folder-open {
            color: var(--highlight-gold);
        }


        #lecture-resource-view {
            display: none;
            padding: 20px;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-dark);
            z-index: 1300;
            overflow-y: auto;
            /* For swipe gesture */
            touch-action: pan-y;
        }
        #lecture-resource-view .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        #lecture-resource-view .back-button {
            background-color: transparent;
            border: none;
            font-size: 2em;
            color: var(--text-dark);
            cursor: pointer;
            margin-right: 18px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #lecture-resource-view .back-button:hover {
            color: var(--accent-purple);
            transform: translateX(-5px);
        }
        #lecture-resource-view h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.2em;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
            flex-grow: 1;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
        }
        .tab-button {
            flex: 1;
            padding: 12px 10px;
            background-color: transparent;
            color: var(--text-light);
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease, border-bottom-color 0.2s ease;
        }
        .tab-button.active {
            color: var(--accent-purple);
            border-bottom-color: var(--accent-purple);
        }
        .tab-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #lectures-container, #resources-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #resources-container {
            display: none;
        }

        .lecture-item, .resource-item {
            background: linear-gradient(135deg, var(--secondary-light), var(--primary-dark));
            border-radius: var(--border-radius-card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease;
            border: 1px solid var(--border-color);
        }
        /* MODIFIED: Increased tilt */
        .lecture-item:hover, .resource-item:hover {
            transform: perspective(1000px) translateY(-8px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .lecture-item .lecture-thumbnail {
           display: block;
           width: 100px;
           height: 70px;
           margin-right: 15px;
           border-radius: var(--border-radius-input);
           object-fit: cover;
           flex-shrink: 0;
           background-color: #1A1A1A;
        }
         .lecture-item .lecture-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
        }
        .item-info { /* Replaces lecture-info */
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none; /* remove underline from link */
        }
        .item-name { /* Replaces lecture-name */
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.4;
            flex-grow: 1;
        }
        .lecture-item.completed .item-name,
        .resource-item.completed .item-name {
            text-decoration: line-through;
            opacity: 0.7;
        }
        /* --- Progress Checkbox --- */
        .progress-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .progress-checkbox:checked {
            background-color: var(--success-green);
            border-color: var(--success-green);
        }
        .progress-checkbox:checked::after {
            content: '✔';
            font-size: 14px;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .resource-item {
            text-decoration: none; /* Remove underline from anchor tag */
        }
        .resource-item .resource-icon {
            font-size: 2.5em;
            color: var(--accent-purple);
            width: 40px;
            text-align: center;
            margin-right: 15px;
        }

        /* --- Bottom Navigation Bar --- */
        .bottom-navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #111827;
            box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-top-left-radius: var(--border-radius-main);
            border-top-right-radius: var(--border-radius-main);
            z-index: 1000;
            transition: transform 0.3s ease;
            border-top: 1px solid var(--border-color);
        }
        .bottom-navbar.hidden {
            transform: translateY(100%);
        }
        .nav-item {
            text-align: center;
            color: var(--text-light);
            font-size: 0.9em;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .nav-item i {
            font-size: 1.8em;
            margin-bottom: 8px;
            transition: color 0.2s ease;
        }
        .nav-item.active {
            color: var(--accent-purple);
            font-weight: 700;
        }
        .nav-item.active i {
            color: var(--accent-purple);
        }
        .nav-item:hover {
            color: var(--accent-purple);
        }
        .nav-item:active {
            transform: scale(0.95);
        }

        /* --- Name Popup Styles (Top Aligned) --- */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed to flex-start for top alignment */
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding-top: 5vh; /* Added padding to push content from top edge */
            overflow-y: auto; /* Allow scrolling */
            box-sizing: border-box;
        }
        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .name-popup {
            background-color: var(--popup-bg);
            padding: 40px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 420px;
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
            margin-bottom: 5vh; /* Margin for scroll spacing */
        }
        .popup-overlay.active .name-popup {
            transform: translateY(0); /* Changed from -50px to 0 for top alignment */
            opacity: 1;
        }
        .name-popup h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2em;
            color: var(--text-dark);
            margin-bottom: 25px;
            font-weight: 700;
        }
        .name-popup p {
            font-size: 1.1em;
            color: var(--text-light);
            margin-bottom: 30px;
        }
        .name-popup .input-container {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-input);
            padding: 12px 18px;
            margin-bottom: 25px;
            position: relative;
            background-color: var(--primary-dark);
            transition: border-color 0.2s ease;
        }
        .name-popup .input-container:focus-within {
            border-color: var(--accent-purple);
        }
        .name-popup input[type="text"] {
            width: 100%;
            padding: 10px 0;
            padding-top: 20px;
            border: none;
            background: transparent;
            font-family: 'Open Sans', sans-serif;
            font-size: 1.2em;
            color: var(--text-dark);
            outline: none;
        }
         .name-popup input[type="text"]:focus + label,
         .name-popup input[type="text"]:not(:placeholder-shown) + label {
            top: 5px;
            font-size: 0.7em;
            color: var(--accent-purple);
        }
        .name-popup .char-count {
            font-size: 0.85em;
            color: var(--text-light);
            text-align: right;
            margin-top: -15px;
            margin-bottom: 25px;
        }
        .name-popup .role-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            font-family: 'Open Sans', sans-serif;
        }
        .name-popup .role-option {
            display: flex;
            align-items: center;
            background-color: #444;
            padding: 8px 15px;
            border-radius: var(--border-radius-pill);
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.9em;
            color: var(--text-light);
        }
        .name-popup .role-option:hover {
            background-color: #555;
        }
        .name-popup input[type="radio"] {
            margin-right: 8px;
            accent-color: var(--accent-purple);
        }
        .name-popup button {
            background: var(--accent-gradient);
            color: white;
            padding: 15px 35px;
            border: none;
            border-radius: var(--border-radius-pill);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .name-popup button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--cyan-glow-color);
        }
        .popup-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .popup-close-button:hover {
            color: var(--text-dark);
        }

        .coming-soon-section {
            display: none;
            text-align: center;
            padding: 50px 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius-main);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            margin-top: 30px;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            border: 1px solid var(--border-color);
            color: var(--text-dark);
        }
        .coming-soon-section h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 20px;
        }
        .coming-soon-section p {
            font-size: 1.3em;
            color: var(--text-light);
            margin-bottom: 30px;
            line-height: 1.5;
        }
        .coming-soon-section .emoji {
            font-size: 3em;
            margin-top: 20px;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        body.animate-in {
            animation: fadeInSlideUp 0.8s ease-out forwards;
        }

        @keyframes popupEnter {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .popup-overlay.active .name-popup,
        .popup-welcome-overlay.active .popup-welcome-content {
            animation: popupEnter 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }


        .hidden-on-scroll {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .visible-on-scroll {
            opacity: 1;
            transform: translateY(0);
        }

        .offline-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 3000;
            color: white;
            font-size: 1.5em;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .offline-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .offline-overlay i {
            font-size: 3em;
            margin-bottom: 20px;
            color: #FFC107;
        }
        .offline-overlay p {
            margin: 0;
            padding: 0 20px;
        }
        .offline-overlay .reload-button {
            background-color: var(--accent-purple);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-pill);
            padding: 10px 20px;
            margin-top: 20px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        .offline-overlay .reload-button:hover {
            background-color: #7c4ee6;
        }

        /* Modified #about-me-view styles */
        #about-me-view {
            display: none; /* Controlled by JS showView() */
            flex-direction: column; /* Keep flex-direction for consistency with showView setting display: flex */
            
            /* New styles to make it a scrollable container within main-content */
            flex-grow: 1; /* Allow it to take up available vertical space within main-content */
            overflow-y: auto; /* Make this div scrollable if its content overflows */
            padding: 0px; /* Add some internal padding */
            box-sizing: border-box; /* Include padding in height calculations */
            background-color: var(--secondary-light); /* Give it a background, consistent with other views */
            border-radius: var(--border-radius-main); /* Keep consistent styling */
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); /* Add a shadow */
            margin-top: 0px; /* Adjust margin as needed, main-content has padding */
            margin-bottom: 0px; /* Adjust margin as needed */
        }

        #about-me-view iframe {
            /* Remove fixed positioning and z-index */
            position: static; 
            top: auto; 
            left: auto; 
            z-index: auto; 

            /* Make it fill its parent container */
            width: 100%; 
            height: 100%; /* This will make it take all available height within #about-me-view */
            min-height: 600px; /* A minimum height to ensure it's visible and displays "full card" */
            display: block; /* Ensure it behaves as a block element */
            border: none; /* Keep border none */
        }
        /* Removed all nested styles for elements that were inside #about-me-view */
        
        .share-app-button {
            background-color: #007bff;
            color: var(--white);
            padding: 15px 25px;
            border-radius: var(--border-radius-pill);
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: none;
        }

        .share-app-button:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4);
        }

        .share-app-button i {
            font-size: 1.5em;
        }

        .slider-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .slider-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .slider-menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background-color: var(--slider-bg);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1600;
            transition: left 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .slider-menu.active {
            left: 0;
        }

        .slider-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
            font-family: 'Comfortaa', sans-serif;
        }

        .slider-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid var(--accent-purple);
            box-shadow: 0 0 8px var(--cyan-glow-color);
        }

        .slider-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--accent-purple);
            margin: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        /* New section header for "Check out" */
        .slider-section-header {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9em;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
            padding: 15px 20px 5px;
            border-bottom: 1px solid var(--border-color);
            margin-top: 10px;
        }


        .slider-menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-dark);
            text-decoration: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 1.05em;
            transition: background-color 0.2s ease, transform 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .slider-menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.3s ease-out;
        }

        .slider-menu-item:hover::before {
            left: 0;
        }

        .slider-menu-item:hover {
            background-color: var(--slider-item-hover);
            transform: translateX(5px);
        }

        .slider-menu-item i {
            font-size: 1.6em;
            margin-right: 15px;
            color: var(--text-light);
            transition: color 0.2s ease;
        }

        .slider-menu-item:hover i {
            color: var(--highlight-gold);
        }

        .slider-menu-item .item-text {
            flex-grow: 1;
            font-weight: 500;
        }

        .slider-menu-item .coming-soon-tag {
            background-color: #FFC107;
            color: #333;
            font-size: 0.7em;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: var(--border-radius-pill);
            margin-left: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .slider-footer {
            margin-top: auto;
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            font-size: 0.85em;
            color: var(--text-light);
            font-family: 'Open Sans', sans-serif;
            line-height: 1.5;
        }

        .slider-footer .version {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
            font-size: 0.9em;
        }
        
        .batch-detail-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .batch-detail-modal-overlay.active {
            opacity: 1;
            visibility: visible;
            display: flex;
        }
        .batch-detail-modal-content {
            background-color: var(--secondary-light);
            padding: 30px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 600px;
            position: relative;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            border: 1px solid var(--border-color);
            color: var(--text-dark);
            max-height: 90vh;
            overflow-y: auto;
        }
        .batch-detail-modal-overlay.active .batch-detail-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .batch-detail-modal-content .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2em;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .batch-detail-modal-content .close-button:hover {
            color: var(--text-dark);
        }
        .batch-detail-modal-content h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-dark);
        }
        .batch-detail-modal-content img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-card);
            margin-bottom: 20px;
        }
        .batch-detail-modal-content .modal-description, .batch-detail-modal-content .modal-overview {
            font-size: 1em;
            line-height: 1.6;
            color: var(--text-light);
            margin-bottom: 20px;
            text-align: justify;
        }
        .batch-detail-modal-content .generate-overview-btn {
            background: var(--accent-gradient);
            color: var(--white);
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-button);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s;
            margin-top: 10px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .batch-detail-modal-content .generate-overview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--cyan-glow-color);
        }
        .batch-detail-modal-content .loading-overview {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            color: var(--text-light);
        }
        .batch-detail-modal-content .loading-overview .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-purple);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification-banner {
            position: fixed;
            top: -150px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: linear-gradient(135deg, var(--secondary-light), var(--primary-dark));
            color: var(--text-dark);
            padding: 20px;
            border-radius: var(--border-radius-card);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--border-color);
        }
        .notification-banner.show {
            top: 90px;
        }
        .notification-banner.hide {
            top: -150px;
        }
        .notification-icon {
            font-size: 2em;
            color: var(--accent-purple);
            animation: pulse 1.5s infinite;
        }
        .notification-content {
            flex-grow: 1;
        }
        .notification-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.1em;
            margin: 0 0 5px 0;
        }
        .notification-text {
            font-size: 0.9em;
            color: var(--text-light);
            margin: 0;
        }
        .notification-action .view-details-btn {
            background: var(--accent-gradient);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-button);
            padding: 8px 15px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .notification-action .view-details-btn:hover {
            transform: scale(1.05);
        }

        .hidden { display: none; }


        /* ======================================================= */
        /* === START: NEW PLAYER VIEW STYLES (MODIFIED) === */
        /* ======================================================= */

        #player-view {
            --primary-glow: var(--accent-purple);
            --secondary-glow: var(--accent-pink);
            background-color: #050208;
            color: #f0f0f0;
            padding: 0; /* Fullscreen view */
        }
        
        /* --- NEW: Plyr Customization for Purple Theme --- */
        #player-view .plyr {
            --plyr-color-main: var(--accent-purple);
            --plyr-video-control-background-hover: rgba(139, 92, 246, 0.15);
            --plyr-video-progress-buffered-background: rgba(139, 92, 246, 0.25);
            --plyr-range-track-background: rgba(139, 92, 246, 0.2);
            --plyr-tooltip-background: var(--accent-purple);
            --plyr-tooltip-color: var(--white);
        }
        #player-view .plyr--video .plyr__control.plyr__tab-focus,
        #player-view .plyr--video .plyr__control:hover,
        #player-view .plyr--video .plyr__control[aria-expanded="true"] {
            background: var(--accent-purple);
        }
        /* --- END: Plyr Customization --- */

        #player-view .player-content-wrapper {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        @keyframes fadeInPlayer {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #player-view .glowing-text {
            /* REMOVED GLOW ANIMATION */
        }

        #player-view .player-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(139, 92, 246, 0.4);
            box-shadow: 0 0 15px -5px rgba(139, 92, 246, 0.3); /* ADDED subtle static shadow */
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #000;
        }
        #player-view .player-wrapper .plyr {
            width: 100%;
            height: 100%;
        }
        #player-view .player-logo img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.7);
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            transition: all 0.3s ease;
            pointer-events: auto; /* Allow clicking the logo */
            user-drag: auto;
        }
        #player-view .player-logo img:hover {
            transform: scale(1.15);
            box-shadow: 0 0 20px var(--primary-glow);
        }
        #player-view .info-card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.7), rgba(17, 24, 39, 0.8));
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px 25px;
            margin-top: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        #player-view .info-card-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f0f0f0;
            margin-bottom: 15px;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        /* --- NEW: Player Engagement Bar --- */
        #player-view .engagement-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }
        #player-view .engagement-button {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #player-view .engagement-button:hover {
            color: #fff;
            transform: scale(1.05);
        }
        #player-view .engagement-button i {
            font-size: 1.4rem;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        #player-view .engagement-button.liked i {
            color: var(--error-red); /* Red when liked */
            transform: scale(1.1);
        }
        /* --- END: Player Engagement Bar --- */

        #player-view .info-card-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        #player-view .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            color: #ccc;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #player-view .info-item i {
            color: var(--primary-glow);
        }
        
        #player-view .cta-button {
            position: relative;
            overflow: hidden;
            border: 1px solid var(--primary-glow);
            color: #fff;
            background-color: transparent;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            padding: 10px 25px;
        }
        #player-view .cta-button:hover {
            background: var(--secondary-glow);
            border-color: var(--secondary-glow);
            box-shadow: 0 0 25px var(--secondary-glow);
            transform: translateY(-4px);
        }
        #player-view .shine-effect::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -25%;
            width: 50%;
            height: 200%;
            opacity: 0;
            transform: rotate(35deg);
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.75s ease;
        }
        #player-view .cta-button:hover .shine-effect::after {
            left: 125%;
            opacity: 1;
        }
        #player-view .disclaimer-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: var(--border-radius-card);
        }
       
        #player-view #floating-text {
            position: absolute;
            bottom: 60px; left: 15px;
            z-index: 150;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 12px; 
            font-weight: bold;
            display: none;
            pointer-events: none;
        }
        
        @media (max-width: 768px) {
            #player-view .player-logo img { width: 60px; height: 60px; top: 10px; left: 10px; }
            #player-view .info-card-title { font-size: 1.2rem; }
            #player-view .info-card-details { justify-content: center; }
            #player-view .engagement-bar { flex-wrap: wrap; justify-content: space-around; }
        }

        /* ======================================================= */
        /* === END: NEW PLAYER VIEW (INTEGRATED & MODIFIED) === */
        /* ======================================================= */
        
        /* --- MODIFIED: REDIRECT POPUP for Bundles/PDFs (Top Aligned) --- */
        #redirect-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: flex-start; /* MODIFIED: Align to top */
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            padding: 10vh 20px; /* MODIFIED: Add top padding */
            box-sizing: border-box;
            overflow-y: auto; /* Allow scrolling */
        }
        #redirect-popup-overlay.show {
            display: flex;
            opacity: 1;
        }
        .redirect-popup-content {
            background: linear-gradient(145deg, var(--secondary-light), var(--primary-dark));
            padding: 30px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 0 25px var(--cyan-glow-color), 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--accent-purple);
            animation: fadeInSlideUp 0.5s ease-out forwards;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            color: var(--text-dark);
            margin-bottom: 10vh; /* MODIFIED: Add bottom margin */
        }
        .redirect-popup-spinner {
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top: 6px solid var(--accent-purple);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }
        .redirect-popup-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5em;
            font-weight: 700;
            margin: 0;
        }
        .redirect-popup-text {
            font-size: 1em;
            color: var(--text-light);
            line-height: 1.6;
            margin: 0;
        }

    </style>
</head>
<body>
    <!-- Access Lock Screen (REDESIGNED) -->
    <div id="access-lock-overlay">
        <div class="access-popup">
            <div class="icon-lock"><i class="fas fa-lock"></i></div>
            <h2>Verification Required</h2>

            <div class="access-instructions">
                <div class="step">
                    <div class="step-number">1</div>
                    <p>Go to our key generator site. You can select how many hours you want the key to be valid for.</p>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <p>Copy the generated key and paste it below to unlock the app.</p>
                </div>
            </div>

            <a href="access earn.html" target="_blank" class="generate-key-btn">
                <i class="fas fa-key"></i> Generate Access Key
            </a>

            <div class="separator"><span>OR, if you have a key</span></div>

            <div class="unlock-area">
                <input type="text" id="key-input" placeholder="PASTE YOUR KEY HERE" maxlength="20">
                <button id="unlock-button" onclick="window.verifyKey()">
                    <i class="fas fa-bolt"></i> Unlock
                </button>
            </div>
            
            <div id="error-message"></div>
        </div>
    </div>


    <!-- NEW Key Success Popup -->
    <div id="key-success-popup-overlay">
        <div class="key-success-popup">
            <div class="icon-container"><i class="fas fa-check"></i></div>
            <h2>Key Activated Successfully! 🥰⚡</h2>
            <p>Your access timer has started. You can check the remaining time in the timer section.</p>
            <button class="success-action-btn" onclick="window.showTimerView(true)">View Timer & Start</button>
        </div>
    </div>


    <!-- Skeleton UI Loading Overlay -->
    <div id="skeleton-overlay">
        <img id="loader-image" src="https://i.postimg.cc/q7bsJ67w/Photo-Room-20250702-182637.png" alt="Loading Animation">
        <div class="loading-bar-container">
            <div class="loading-bar-fill"></div>
        </div>
        <h1 id="loader-title">SkillNeast</h1>
        <p id="loader-tagline">Navigation your skill ⚡</p>
    </div>

    <!-- Welcome Popup -->
    <div class="popup-welcome-overlay" id="welcomePopupOverlay">
        <div class="popup-welcome-content">
            <button class="popup-close-btn" id="welcomePopupCloseBtn">&times;</button>
            <img class="popup-header-image" id="welcomePopupImage" src="" alt="Popup Header" 
                 onerror="this.onerror=null;this.src='';this.classList.add('error-fallback');this.alt='SkillNeast';">
            <div class="popup-main-content">
                <h2 id="welcomePopupTitle"></h2>
                <p id="welcomePopupDescription"></p>
                <ul class="popup-features-list" id="welcomePopupFeatures"></ul>
                <div class="popup-button-group" id="welcomePopupButtonGroup"></div>
            </div>
        </div>
    </div>

    <!-- Offline Overlay -->
    <div class="offline-overlay" id="offlineOverlay">
        <i class="fas fa-wifi"></i>
        <p>No Internet Connection 😕</p>
        <button class="reload-button" onclick="location.reload()">Retry 🔁</button>
    </div>

    <!-- Name Entry Popup -->
    <div class="popup-overlay" id="namePopupOverlay">
        <div class="name-popup">
            <button class="popup-close-button" onclick="window.closeNamePopup()">×</button>
            <h2>Welcome to SkillNeast!</h2>
            <p>Please tell us your name and what you do to personalize your experience.</p>
            <div class="input-container">
                <label for="userNameInput" style="position: absolute; top: 12px; left: 18px; font-size: 0.9em; color: var(--text-light); transition: all 0.2s ease;">Enter Your Name</label>
                <input type="text" id="userNameInput" placeholder=" " maxlength="15" onkeyup="window.updateCharCount()">
            </div>
            <div class="char-count"><span id="currentCharCount">0</span>/15</div>
            <div class="role-selection">
                <label class="role-option"><input type="radio" name="userRole" value="Editor"> Editor ✂️</label>
                <label class="role-option"><input type="radio" name="userRole" value="Programmer"> Programmer 💻</label>
                <label class="role-option"><input type="radio" name="userRole" value="Content Creator"> Content Creator 🎬</label>
                <label class="role-option"><input type="radio" name="userRole" value="Music Artist"> Music Artist 🎶</label>
                <label class="role-option"><input type="radio" name="userRole" value="Other" checked> Other ✨</label>
            </div>
            <button onclick="window.submitName()">START LEARNING</button>
        </div>
    </div>

    <!-- MODIFIED: Redirect Popup for Bundles/PDFs -->
    <div id="redirect-popup-overlay">
        <div class="redirect-popup-content">
            <div class="redirect-popup-spinner"></div>
            <h3 class="redirect-popup-title" id="redirect-popup-title">Redirecting...</h3>
            <p class="redirect-popup-text" id="redirect-popup-text">Please wait while we take you to the requested section.</p>
        </div>
    </div>

    <div class="batch-detail-modal-overlay" id="batchDetailModalOverlay">
        <div class="batch-detail-modal-content">
            <button class="close-button" onclick="window.closeBatchDetailModal()">×</button>
            <h3 id="modalBatchTitle"></h3>
            <img id="modalBatchImage" src="" alt="Batch Image" />
            <p id="modalBatchDescription" class="modal-description"></p>
            <button class="generate-overview-btn" id="generateOverviewBtn">Generate AI Overview ✨</button>
            <div id="loadingOverview" class="loading-overview" style="display: none;">
                <div class="spinner"></div>
                <span>Generating overview...</span>
            </div>
            <p id="generatedOverview" class="modal-overview"></p>
        </div>
    </div>

    <div class="top-navbar" id="top-navbar">
        <div class="menu-icon" onclick="window.openSliderMenu()"><i class="fas fa-bars"></i></div>
        <div class="app-logo" id="appLogo">
            <img src="" alt="SkillNeast Logo" draggable="false" id="skillNeastLogo" onerror="this.onerror=null;this.src='https://via.placeholder.com/40x40/8B5CF6/ffffff?text=SN';">
            <div class="text-wrapper"> <span class="main-title">SKILLNEAST</span>
                <span class="tagline">Master New Skill 🚀💡</span>
            </div>
        </div>
        <div class="notification-icon-wrapper" onclick="window.showNotificationsView()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="topNotificationBadge">0</span>
        </div>
    </div>

    <!-- NEW: BATCH PROGRESS BAR -->
    <div id="batch-progress-bar-container">
        <h3 id="progress-bar-title">Batch Progress</h3>
        <div class="progress-bar">
            <div id="progress-bar-fill" class="progress-bar-fill"></div>
        </div>
        <span id="progress-bar-percentage">0%</span>
    </div>
    
    <div id="homepage-notification-banner" class="notification-banner"></div>
    <audio id="notification-sound" src="" preload="auto"></audio>


    <div class="main-content" id="main-content">

        <div class="welcome-banner">
            <span class="greeting"><i class="fas fa-heart"></i> Welcome <span id="displayedUserName">Guest</span></span>
            <span class="fire-icon"><i class="fas fa-fire"></i></span>
            <span class="role-sticker" id="displayedUserRole" style="display: none;"></span>
        </div>

        <div class="quote-section">
            <p class="quote-text" id="quoteText"></p>
            <p class="quote-author" id="quoteAuthor"></p>
        </div>

        <div id="home-view" style="display: none;">
            <div class="info-cards-wrapper" id="home-info-cards-wrapper">
                <div class="telegram-channels-banner" id="telegramBannerContainer" style="display: none;">
                    </div>
                <div class="discover-notice" id="discoverNoticeContainer" style="display: none;">
                    </div>
            </div>
            <div id="course-categories-grid">
                </div>

            <!-- === NEW: FAVORITES CARD REVAMPED === -->
            <div class="favorites-section-home-card" onclick="window.showFavoritesView()" id="favorites-section-home-card">
                <i class="fas fa-heart fav-icon"></i>
                <h2>My Favorite Batches</h2>
                <p>Keep your top courses here!</p>
                <span class="fav-count" id="favorites-count">0 Batches</span>
            </div>
            
            <!-- === NEW: REORDERED TELEGRAM CARD === -->
            <div class="telegram-card" onclick="window.open(window.siteConfig.telegramGroupLink || 'https://t.me/skillneastreal');">
                <i class="fab fa-telegram-plane telegram-icon-large"></i>
                <span class="telegram-text">Join Our Telegram Community!</span>
            </div>
            
            <!-- === NEW: GROUPED ACTION BUTTONS === -->
            <div class="home-actions-grid">
                <a href="#" target="_blank" class="home-action-btn surprise" id="surpriseBtn">
                    <i class="fas fa-gift"></i>
                    <div class="action-btn-text">
                        <h4>Surprise Me!</h4>
                        <p>Discover random amazing courses.</p>
                    </div>
                </a>
                <a href="#" class="home-action-btn request" onclick="window.showRequestCoursesView();">
                    <i class="fas fa-hand-paper"></i> 
                    <div class="action-btn-text">
                        <h4>Request Courses</h4>
                        <p>Have a course in mind? Let us know.</p>
                    </div>
                </a>
                <a href="#" class="home-action-btn share" onclick="window.shareApp()">
                    <i class="fas fa-share-alt"></i> 
                     <div class="action-btn-text">
                        <h4>Share App</h4>
                        <p>Share the knowledge with friends.</p>
                    </div>
                </a>
                <a href="#" class="home-action-btn timer" onclick="window.showTimerView()">
                    <i class="fas fa-stopwatch"></i> 
                     <div class="action-btn-text">
                        <h4>Access Timer</h4>
                        <p>Check your remaining access time.</p>
                    </div>
                </a>
            </div>
        </div>

        <div id="new-batches-view" style="display: none;">
            <div class="section-header">
                <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
                <h2 id="new-batches-title">All Courses</h2>
            </div>
            <div class="search-bar-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="batchSearchInput" placeholder="Search by batch name" onkeyup="window.filterBatches()">
                <button class="search-button" onclick="window.filterBatches()">Search</button>
            </div>
            <div class="batch-list" id="batches-container">
                <!-- Skeletons will be injected here by JS -->
            </div>
        </div>

        <div id="favorites-view" style="display: none;">
            <div class="section-header">
                <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
                <h2>Favourite Batches</h2>
            </div>
            <div class="batch-list" id="favorite-batches-container">
            </div>
            <p id="no-favorites-message-view" class="no-favorites-message-view" style="display: none;">You haven't favorited any batches yet. Click the heart icon on any batch to add it here!</p>
        </div>

        <div id="about-me-view" style="display: none;">
            <iframe src="https://skillneast.github.io/Aboutsection/" 
                    width="100%" 
                    height="100%" 
                    style="border: none; min-height: 600px;">
            </iframe>
        </div>
    </div>
       
    <!-- ======================================================= -->
    <!-- === START: FULLSCREEN OVERLAY VIEWS === -->
    <!-- ======================================================= -->

    <!-- Timer View -->
    <div id="timer-view" style="display: none;">
        <div class="section-header">
            <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
            <h2>Access Timer</h2>
        </div>
        <div class="timer-container">
            <p class="timer-message">Your generated key's Go now! 🚀 Learn a skill or anything new 🎓 because time waits for no one ⏳ — history is the proof 📜
            The timer is running below ⌛⏳ 👇⚡ live</p>
            <div class="timer-display">
                <div class="timer-box">
                    <div id="timer-hours" class="timer-value">00</div>
                    <div class="timer-label">Hours</div>
                </div>
                 <div class="timer-box">
                    <div id="timer-minutes" class="timer-value">00</div>
                    <div class="timer-label">Minutes</div>
                </div>
                 <div class="timer-box">
                    <div id="timer-seconds" class="timer-value">00</div>
                    <div class="timer-label">Seconds</div>
                </div>
            </div>
            <div id="no-active-timer-message" style="display:none; color: var(--text-light); margin-top: 20px; font-size: 1.1em;">
                You do not have an active key.
            </div>
        </div>
    </div>
       
    <div id="sections-view" style="display: none;">
        <div class="section-header">
            <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
            <h2 id="sections-title"></h2>
        </div>
        <div class="sections-container" id="sections-container">
        </div>
    </div>

    <!-- Notifications View -->
    <div id="notifications-view" style="display: none;">
        <div class="section-header">
            <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
            <h2>Notifications</h2>
            <button class="mark-all-read-btn" id="markAllReadBtn" onclick="window.markAllNotificationsAsRead()">Mark All Read</button>
        </div>
        <div class="tab-buttons">
            <button id="personal-tab-btn" class="tab-button active" onclick="window.switchNotificationTab('personal')">Personal</button>
            <button id="announcements-tab-btn" class="tab-button" onclick="window.switchNotificationTab('announcements')">Announcements</button>
        </div>
        <div class="notification-list-container">
            <div id="personal-notifications-container" class="notification-list"></div>
            <div id="announcements-notifications-container" class="notification-list" style="display: none;"></div>
        </div>
    </div>

    <!-- Request Courses View -->
    <div id="request-courses-view" style="display: none;">
        <div class="section-header">
            <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
            <h2>Request Courses</h2>
        </div>
        <div class="request-list-container" id="request-list-container">
            <p class="text-center text-muted" style="padding: 20px;">Loading requested courses...</p>
        </div>
    </div>

    <div id="lecture-resource-view" style="display: none;">
        <div class="section-header">
            <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
            <h2 id="lecture-resource-title"></h2>
        </div>
        <div class="tab-buttons">
            <button id="lectures-tab-btn" class="tab-button active" onclick="window.switchTab('lectures')">Lectures</button>
            <button id="resources-tab-btn" class="tab-button" onclick="window.switchTab('resources')">Resources</button>
        </div>
        <div class="tab-content">
            <div id="lectures-container"></div>
            <div id="resources-container" style="display: none;"></div>
        </div>
    </div>

    <!-- ======================================================= -->
    <!-- === START: NEW PLAYER VIEW (INTEGRATED & MODIFIED) === -->
    <!-- ======================================================= -->
    <div id="player-view" style="display: none;">
        <div class="section-header">
            <button class="back-button" onclick="window.navigateBack()"><i class="fas fa-arrow-left"></i></button>
            <h2 class="glowing-text">Player</h2>
        </div>
        <div class="player-content-wrapper">
            <div class="player-wrapper">
                <a href="#" target="_blank" class="player-logo" id="player-logo-link">
                    <img src="https://i.postimg.cc/NFPzT9dy/file-00000000fde061f7b24dbaddd2b9ac88.png" alt="Logo">
                </a>
                <!-- MODIFIED: Removed static poster attribute. It will be set by JS. -->
                <video id="video-player" playsinline controls></video>
                <div id="floating-text">https://t.me/skillneast</div>
            </div>

            <div class="info-card">
                <h2 id="card-video-title" class="info-card-title">Loading title...</h2>
                
                <div class="engagement-bar">
                    <button class="engagement-button" id="like-btn">
                        <i class="bi bi-heart"></i>
                        <span id="like-count">0</span>
                    </button>
                    <button class="engagement-button" id="comment-btn">
                        <i class="bi bi-chat-left-text"></i>
                        <span>Comment</span>
                    </button>
                    <button class="engagement-button" id="bookmark-btn">
                        <i class="bi bi-bookmark"></i>
                        <span>Bookmark</span>
                    </button>
                </div>

                <div class="info-card-details">
                    <div class="info-item">
                        <i class="bi bi-hdd-stack-fill"></i>
                        <span id="video-size">Loading size...</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-gem"></i>
                        <span>Provided by: <strong>@skillneast</strong></span>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin: 25px 0;">
                <a href="#" download class="cta-button rounded-pill shine-effect" id="download-video-btn">
                    <i class="bi bi-download"></i> Download Video
                </a>
                <a href="#" target="_blank" class="cta-button rounded-pill shine-effect" id="telegram-channel-btn">
                    <i class="bi bi-telegram"></i> Join Telegram Channel
                </a>
            </div>

            <div class="disclaimer-box">
                 <h4 style="text-align: center; margin-bottom: 1rem; font-weight: bold;"><i class="bi bi-shield-check"></i> Disclaimer</h4>
                 <p style="text-align: center; font-size: 0.8rem;">This website is for educational purposes only. All content is streamed from publicly available third-party services, and we do not host any media. Users are responsible for complying with their local laws and are encouraged to support the original content creators.</p>
            </div>
        </div>
    </div>
    <!-- ======================================================= -->
    <!-- === END: NEW PLAYER VIEW (INTEGRATED & MODIFIED) === -->
    <!-- ======================================================= -->
    
    <div class="bottom-navbar" id="bottom-navbar">
        <a href="#" class="nav-item" id="courses-nav" onclick="window.showNewBatchesView('all'); window.highlightBottomNav('courses-nav')"><i class="fas fa-book-open"></i> Courses</a>
        <a href="#" class="nav-item" id="bundles-nav" onclick="window.handleRedirect('bundles'); window.highlightBottomNav('bundles-nav');"><i class="fas fa-boxes"></i> Bundles</a>
        <a href="#" class="nav-item active" id="home-nav" onclick="window.showHomeView(); window.highlightBottomNav('home-nav')"><i class="fas fa-home"></i> Home</a>
        <a href="#" class="nav-item" id="pdfs-nav" onclick="window.handleRedirect('pdfs'); window.highlightBottomNav('pdfs-nav');"><i class="fas fa-file-pdf"></i> PDFs</a>
        <a href="#" class="nav-item" id="about-me-nav" onclick="window.showAboutMeView(); window.highlightBottomNav('about-me-nav');"><i class="fas fa-user-circle"></i> About Me</a>
    </div>

    <div class="slider-menu-overlay" id="sliderMenuOverlay" onclick="window.closeSliderMenu()"></div>
    <div class="slider-menu" id="sliderMenu">
        <div class="slider-header">
            <img src="" alt="SkillNeast Logo" id="sliderHeaderLogo" onerror="this.onerror=null;this.src='https://via.placeholder.com/50x50/8B5CF6/ffffff?text=SN';">
            <h3>SkillNeast</h3>
        </div>
        
        <!-- Home button moved to top of slider -->
        <a href="#" class="slider-menu-item" onclick="window.showHomeView(); window.closeSliderMenu();">
            <i class="fas fa-home"></i> <span class="item-text">Home</span>
        </a>

        <!-- NEW Timer Button in Slider -->
        <a href="#" class="slider-menu-item" onclick="window.showTimerView(); window.closeSliderMenu();">
            <i class="fas fa-stopwatch"></i> <span class="item-text">Access Timer</span>
        </a>
        
        <a href="#" class="slider-menu-item" onclick="window.showAboutMeView(); window.closeSliderMenu();">
            <i class="fas fa-user-circle"></i> <span class="item-text">About Me</span>
        </a>
        <a href="#" class="slider-menu-item" onclick="window.showFavoritesView(); window.closeSliderMenu();">
            <i class="fas fa-heart"></i> <span class="item-text">Favorite Batches</span>
        </a>
        <a href="" target="_blank" class="slider-menu-item" id="sliderTelegramChannelLink">
            <i class="fab fa-telegram-plane"></i> <span class="item-text">Join Telegram Channel</span>
        </a>
        <a href="" target="_blank" class="slider-menu-item" id="sliderTelegramGroupLink">
            <i class="fab fa-telegram-plane"></i> <span class="item-text">Join Telegram Group</span>
        </a>
        <a href="#" class="slider-menu-item" onclick="window.showRequestCoursesView();"> <!-- Updated link -->
            <i class="fas fa-hand-paper"></i> <span class="item-text">Request Courses</span>
        </a>
        <a href="#" class="slider-menu-item" onclick="window.shareApp(); window.closeSliderMenu();">
            <i class="fas fa-share-alt"></i> <span class="item-text">Share with your Friends</span>
        </a>
        
        <!-- New "Check out" section in slider -->
        <div class="slider-section-header">Check out</div>
        <a href="#" class="slider-menu-item" onclick="window.handleExternalLink('#', 'SkillNeast');">
            <i class="fas fa-globe"></i> <span class="item-text">SkillNeast</span>
        </a>
        <a href="#" class="slider-menu-item" onclick="window.handleExternalLink('#', 'CoderNeast');">
            <i class="fas fa-code"></i> <span class="item-text">CoderNeast</span>
        </a>
        <a href="#" class="slider-menu-item" onclick="window.handleExternalLink('#', 'PDFNeast');">
            <i class="fas fa-file-pdf"></i> <span class="item-text">PDFNeast</span>
        </a>
        <a href="#" class="slider-menu-item" onclick="window.handleExternalLink('#', 'StudyNeast');">
            <i class="fas fa-book-reader"></i> <span class="item-text">StudyNeast</span>
        </a>
        
        <div class="slider-footer">
            <div class="version">App Version: v1.1.0 (G.O.A.T)</div>
            Made with ❤️ in INDIA 🇮🇳
        </div>
    </div>

    <!-- NEW Image Viewer Overlay -->
    <div class="image-viewer-overlay" id="imageViewerOverlay" style="display:none;">
        <button class="image-viewer-close-btn" onclick="window.closeFullImageViewer()">&times;</button>
        <img src="" alt="Full View" class="image-viewer-content" id="fullViewerImage">
    </div>

    <!-- DOMPurify for XSS protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script> 
    <!-- Plyr.js for Video Player -->
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as dbRef, onValue, push, set, serverTimestamp, get, child, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getFirestore, collection, query, where, addDoc, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";


        const firebaseConfig = {
          apiKey: "AIzaSyChwpbFb6M4HtG6zwjg0AXh7Lz9KjnrGZk",
          authDomain: "adminneast.firebaseapp.com",
          databaseURL: "https://adminneast-default-rtdb.firebaseio.com",
          projectId: "adminneast",
          storageBucket: "adminneast.appspot.com", 
          messagingSenderId: "883877553418",
          appId: "1:883877553418:web:84ce8200f4b471bfffc6f3",
          measurementId: "G-PCH99BDF1S"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const rtdb = getDatabase(app); 
        const auth = getAuth(app);
        const firestore = getFirestore(app);

        let isAuthenticated = false;
        let currentUserId = null;
        let globalTimerInterval = null; 
        let plyrInstance = null; // Global variable for the player instance

        // --- Access Control Functions ---
        const checkAccess = () => {
            const expiry = localStorage.getItem('accessExpiry');
            if (expiry && Date.now() < parseInt(expiry, 10)) {
                document.getElementById('access-lock-overlay').style.display = 'none';
                startGlobalTimer(); 
                return true;
            } else {
                localStorage.removeItem('accessExpiry');
                document.getElementById('access-lock-overlay').style.display = 'flex';
                if(globalTimerInterval) clearInterval(globalTimerInterval); 
                return false;
            }
        };

        window.verifyKey = async () => {
            const keyInput = document.getElementById('key-input');
            const unlockButton = document.getElementById('unlock-button');
            const errorMessage = document.getElementById('error-message');
            const key = keyInput.value.trim().toUpperCase();

            if (key.length < 5) {
                errorMessage.textContent = 'Please enter a valid key.';
                return;
            }

            unlockButton.disabled = true;
            unlockButton.innerHTML = 'Verifying...';
            errorMessage.textContent = '';

            try {
                const keyRef = dbRef(rtdb, 'access_keys/' + key);
                const snapshot = await get(keyRef);

                if (!snapshot.exists()) {
                    errorMessage.textContent = 'This key is invalid.';
                } else if (snapshot.val().used === true) {
                    errorMessage.textContent = 'This key has already been used.';
                } else if (snapshot.val().expiresAt && Date.now() > snapshot.val().expiresAt) {
                    errorMessage.textContent = 'This key has expired and can no longer be activated.';
                } else {
                    const keyData = snapshot.val();
                    const validityHours = keyData.validityHours || 24; 
                    const expiryTimestamp = Date.now() + (validityHours * 60 * 60 * 1000);

                    localStorage.setItem('accessExpiry', expiryTimestamp);

                    await set(keyRef, {
                        ...keyData,
                        used: true,
                        usedAt: serverTimestamp(),
                        usedBy: currentUserId
                    });

                    document.getElementById('access-lock-overlay').style.display = 'none';
                    showKeySuccessPopup();
                    startGlobalTimer();
                }
            } catch (error) {
                // console.error("Error verifying key:", error);
                errorMessage.textContent = 'An error occurred. Please try again.';
            } finally {
                unlockButton.disabled = false;
                unlockButton.innerHTML = '<i class="fas fa-bolt"></i> Unlock';
            }
        };

        // --- Key Success Popup ---
        function showKeySuccessPopup() {
            const overlay = document.getElementById('key-success-popup-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function hideKeySuccessPopup() {
            const overlay = document.getElementById('key-success-popup-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // --- Timer Functions ---
        function startGlobalTimer() {
            if (globalTimerInterval) clearInterval(globalTimerInterval);

            const expiryTimestamp = parseInt(localStorage.getItem('accessExpiry'), 10);
            if (!expiryTimestamp || isNaN(expiryTimestamp)) return;

            globalTimerInterval = setInterval(() => {
                const now = Date.now();
                const remaining = expiryTimestamp - now;

                if (remaining <= 0) {
                    clearInterval(globalTimerInterval);
                    localStorage.removeItem('accessExpiry');
                    alert("Your access has expired. Please get a new key.");
                    location.reload();
                    return;
                }

                const hours = Math.floor((remaining / (1000 * 60 * 60)));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                if (navigationStack.length > 0 && navigationStack[navigationStack.length-1]?.viewId === 'timer-view') {
                    document.getElementById('timer-hours').textContent = hours.toString().padStart(2, '0');
                    document.getElementById('timer-minutes').textContent = minutes.toString().padStart(2, '0');
                    document.getElementById('timer-seconds').textContent = seconds.toString().padStart(2, '0');
                }
            }, 1000);
        }

        window.showTimerView = function(fromSuccessPopup = false) {
            if (fromSuccessPopup) {
                hideKeySuccessPopup();
            }
            window.showView('timer-view');
            const expiry = localStorage.getItem('accessExpiry');
            
            if (expiry && Date.now() < parseInt(expiry, 10)) {
                document.getElementById('timer-view').querySelector('.timer-container').style.display = 'block';
                document.getElementById('no-active-timer-message').style.display = 'none';
                startGlobalTimer();
            } else {
                document.getElementById('timer-view').querySelector('.timer-container').style.display = 'none';
                document.getElementById('no-active-timer-message').style.display = 'block';
            }
        }

        window.siteConfig = {
            telegramChannelLink: 'https://t.me/default_channel',
            telegramGroupLink: 'https://t.me/default_group',
            youtubeLink: 'https://youtube.com/default_channel',
            instagramLink: 'https://instagram.com/default_profile',
            requestCoursesLink: '#',
            surpriseButtonLink: '#',
            bundlesRedirectUrl: 'https://skillneast.github.io/Bundlesection/', // URL for Bundles section
            pdfsRedirectUrl: 'https://skillneast.github.io/PDFsection/', // URL for PDFs section
            profilePictureUrl: 'https://via.placeholder.com/120x120/8B5CF6/ffffff?text=Fahad',
            skillNeastLogoUrl: 'https://via.placeholder.com/40x40/8B5CF6/ffffff?text=SN',
            sliderHeaderPictureUrl: 'https://via.placeholder.com/50x50/8B5CF6/ffffff?text=SN',
            defaultLectureThumbnail: 'https://via.placeholder.com/100x70/1F2937/FFFFFF?text=Lecture',
            notificationSoundUrl: '', 
            welcomePopup: {
                enabled: true,
                showOncePerSession: true,
                delay: 1500,
                imageUrl: 'https://i.ibb.co/6w2wz7N/Whats-App-Image-2024-03-24-at-20-00-51-ad7b0193.jpg',
                title: 'Note: This App is 100% FREE!',
                description: 'If someone charged you for this app, ask for a refund immediately.',
                features: [
                    'Due to frequent copyright issues on Telegram, all official updates are now shared on WhatsApp.',
                    'The Telegram link is available in our official WhatsApp channel. Only join that one – all others are unofficial.',
                    'Stay updated, stay safe! 🔒🚩'
                ],
                buttons: [
                    {
                        text: "Join Now",
                        link: "https://whatsapp.com/channel/0029VaYCo9GDDm2y50f3sH32",
                        isPrimary: true
                    },
                    {
                        text: "Cancel",
                        link: "#",
                        isPrimary: false
                    }
                ]
            },
            telegramBanner: {
                enabled: true,
                superTitle: "⚠️ WE NEED ⚠️",
                mainTitle: "JOIN OUR OFFICIAL TELEGRAM CHANNELS",
                channels: [
                    "• Study Ratna 🗳️",
                    "• RATNA Official 📢",
                    "• Anime Speaks 💨",
                    "• Code with RATNA </>",
                ],
                buttonText: "CLICK HERE!",
                buttonLink: "https://t.me/",
                footerText: "YOUR SUPPORT !!"
            },
            discoverNotice: {
                enabled: true,
                superTitle: '🙏 Namo Buddhaya Everyone 🙏',
                mainTitle: "DISCOVER OUR APP'S DELIGHTS!",
                points: [
                    "🚫 Don't buy this App from AnyOne. This App is Free 🆓 of Cost for EveryOne. Unfortunately, If you Purchased this App, then please report! that user who sold you this App and take your Money Back.",
                    "🤝 Join Us on Telegram : Scam se bachne ke liye, Get updates, mentorship, and connect with us."
                ],
                reactions: {
                    heart: 0,
                    laugh: 0,
                    thumb: 0,
                    star: 1
                }
            }
        };

        const authenticateFirebase = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                    currentUserId = userCredential.user.uid;
                    isAuthenticated = true;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    currentUserId = userCredential.user.uid; 
                    isAuthenticated = true;
                }
            } catch (error) {
                // console.error("Firebase authentication error:", error);
                alert("Firebase Authentication Error: " + error.message);
            }
        };

        const quotes = [
            { quote: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { quote: "Success is not final, failure is not fatal: It is the courage to continue that counts.", author: "Winston Churchill" },
            { quote: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" }
        ];
        const allEmojis = ['✨', '🚀', '💡', '🌟', '💪', '🔥', '💖', '🎓', '📚', '🎯'];
        let availableQuoteIndices = [];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        let allCategoriesData = {}; 
        window.favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        
        let navigationStack = [];
        let allPersonalNotifications = {};
        let allAnnouncements = {};
        let unreadNotificationCount = 0;
        let activeNotificationTab = 'announcements'; 

        let allRequestedCourses = {}; 

        const reactionEmojis = [
            { emoji: '❤️', type: 'heart', color: 'var(--request-reacted-color-heart)' },
            { emoji: '👍', type: 'thumbsup', color: 'var(--request-reacted-color-thumbsup)' },
            { emoji: '🥰', type: 'smile', color: 'var(--request-reacted-color-smile)' },
            { emoji: '😁', type: 'laugh', color: 'var(--request-reacted-color-laugh)' }
        ];
        
        // --- NEW: Swipe Navigation Variables ---
        let touchstartX = 0;
        let touchendX = 0;
        
        // --- NEW: Helper function to sort items by 'order' property ---
        function sortItemsByOrder(itemsObject) {
            if (!itemsObject) return [];
            return Object.entries(itemsObject).sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await authenticateFirebase();
            
            if (!checkAccess()) {
                document.getElementById('skeleton-overlay').classList.add('hidden');
                return;
            }

            document.getElementById('skeleton-overlay').classList.remove('hidden');

            await Promise.all([
                loadAllCategoriesFromFirebase(), 
                loadSiteConfigAndApply() 
            ]);
            
            document.getElementById('skeleton-overlay').classList.add('hidden');

            listenForTopBarNotifications(); 
            listenForRequestedCourses();
            listenForHomepageNotifications(); 
            
            // --- NEW: Initialize Swipe Navigation ---
            initSwipeNavigation();

            initWelcomePopup(); 

            let userName = localStorage.getItem('userName');
            let userRole = localStorage.getItem('userRole');
            
            document.body.classList.add('animate-in'); 

            if (userName && userRole) { 
                updateWelcomeSection();
            }

            for (let i = 0; i < quotes.length; i++) {
                availableQuoteIndices.push(i);
            }
            shuffleArray(availableQuoteIndices);

            window.showHomeView(); 
            
            renderFavoritesSectionHomeCard();
            window.updateQuote();
            setInterval(window.updateQuote, 6 * 60 * 60 * 1000);

            document.addEventListener('contextmenu', (e) => { e.preventDefault(); });
            document.addEventListener('click', handleReactionClick);


            function updateOnlineStatus() {
                const offlineOverlay = document.getElementById('offlineOverlay');
                if (navigator.onLine) {
                    offlineOverlay.classList.remove('active');
                } else {
                    offlineOverlay.classList.add('active');
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            const appLogo = document.getElementById('appLogo');
            const skillNeastLogoImage = document.getElementById('skillNeastLogo');
            appLogo.addEventListener('click', () => {
                if (!skillNeastLogoImage.classList.contains('rotating')) {
                    skillNeastLogoImage.classList.add('rotating');
                    setTimeout(() => {
                        skillNeastLogoImage.classList.remove('rotating');
                        location.reload();
                    }, 1000);
                }
            });
        });
        
        function initWelcomePopup() {
            const config = window.siteConfig.welcomePopup;
            if (!config || !config.enabled) {
                let userName = localStorage.getItem('userName');
                let userRole = localStorage.getItem('userRole');
                if (!userName || !userRole) {
                    document.getElementById('namePopupOverlay').classList.add('active');
                    document.querySelector('input[name="userRole"][value="Other"]').checked = true;
                }
                return;
            }

            if (config.showOncePerSession && sessionStorage.getItem('welcomePopupShown')) {
                let userName = localStorage.getItem('userName');
                let userRole = localStorage.getItem('userRole');
                if (!userName || !userRole) {
                    document.getElementById('namePopupOverlay').classList.add('active');
                    document.querySelector('input[name="userRole"][value="Other"]').checked = true;
                }
                return;
            }
            
            setTimeout(showWelcomePopup, config.delay || 1000);
        }

        function showWelcomePopup() {
            const config = window.siteConfig.welcomePopup;
            const overlay = document.getElementById('welcomePopupOverlay');
            if (!config || !overlay) return;

            document.getElementById('welcomePopupTitle').textContent = DOMPurify.sanitize(config.title);
            document.getElementById('welcomePopupDescription').innerHTML = DOMPurify.sanitize(config.description);

            const imageEl = document.getElementById('welcomePopupImage');
            if (config.imageUrl) {
                imageEl.src = config.imageUrl;
                imageEl.style.display = 'block';
                imageEl.classList.remove('error-fallback'); 
            } else {
                imageEl.src = ''; 
                imageEl.classList.add('error-fallback'); 
            }

            const featuresList = document.getElementById('welcomePopupFeatures');
            featuresList.innerHTML = '';
            if (config.features && config.features.length > 0) {
                config.features.forEach(feature => {
                    const li = document.createElement('li');
                    li.innerHTML = `<i class="fas fa-check-circle"></i> ${DOMPurify.sanitize(feature)}`;
                    featuresList.appendChild(li);
                });
            }

            const buttonGroup = document.getElementById('welcomePopupButtonGroup');
            buttonGroup.innerHTML = '';
            if (config.buttons && config.buttons.length > 0) {
                config.buttons.forEach(btnConfig => {
                    if (btnConfig.link === '#') {
                        const btn = document.createElement('button');
                        btn.textContent = DOMPurify.sanitize(btnConfig.text);
                        btn.className = `popup-btn ${btnConfig.isPrimary ? 'primary' : 'secondary'}`;
                        btn.onclick = closeWelcomePopup; 
                        buttonGroup.appendChild(btn);
                    } else {
                        const a = document.createElement('a');
                        a.textContent = DOMPurify.sanitize(btnConfig.text);
                        a.href = DOMPurify.sanitize(btnConfig.link);
                        a.target = '_blank';
                        a.className = `popup-btn ${btnConfig.isPrimary ? 'primary' : 'secondary'}`;
                        a.onclick = () => {
                            closeWelcomePopup(); 
                            if (a.href !== '#' && !a.href.startsWith(window.location.origin)) { 
                                window.open(a.href, '_blank');
                            }
                        };
                        buttonGroup.appendChild(a);
                    }
                });
            }
            
            document.getElementById('welcomePopupCloseBtn').onclick = closeWelcomePopup;
            overlay.classList.add('active');
        }

        window.closeWelcomePopup = function() {
            const overlay = document.getElementById('welcomePopupOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
            if (window.siteConfig.welcomePopup.showOncePerSession) {
                sessionStorage.setItem('welcomePopupShown', 'true');
            }
            let userName = localStorage.getItem('userName');
            let userRole = localStorage.getItem('userRole');
            if (!userName || !userRole) {
                document.getElementById('namePopupOverlay').classList.add('active');
                document.querySelector('input[name="userRole"][value="Other"]').checked = true;
            }
        }

        function handleReactionClick(e) {
            const reactionIcon = e.target.closest('.reaction-icon-discover');
            if (!reactionIcon) return;

            const noticeContainer = reactionIcon.closest('.discover-notice');
            const noticeId = noticeContainer.dataset.noticeId;
            const clickedType = reactionIcon.dataset.reactionType;
            
            if (!noticeId || !clickedType) return;

            const storageKey = `reaction_${noticeId}`;
            const previousReaction = localStorage.getItem(storageKey);

            if (previousReaction) {
                const prevIcon = noticeContainer.querySelector(`[data-reaction-type="${previousReaction}"]`);
                if (prevIcon) {
                    const prevCountSpan = prevIcon.querySelector('.reaction-count');
                    let prevCount = parseInt(prevCountSpan.textContent, 10);
                    prevCountSpan.textContent = Math.max(0, prevCount - 1);
                    prevIcon.classList.remove('reacted');
                }
            }

            if (previousReaction === clickedType) {
                localStorage.removeItem(storageKey);
            } 
            else {
                const newCountSpan = reactionIcon.querySelector('.reaction-count');
                let newCount = parseInt(newCountSpan.textContent, 10);
                newCountSpan.textContent = newCount + 1;
                reactionIcon.classList.add('reacted');
                localStorage.setItem(storageKey, clickedType);
            }
        }


        window.updateQuote = function() {
            const quoteTextElement = document.getElementById('quoteText');
            const quoteAuthorElement = document.getElementById('quoteAuthor');
            if (availableQuoteIndices.length === 0) {
                for (let i = 0; i < quotes.length; i++) availableQuoteIndices.push(i);
                shuffleArray(availableQuoteIndices);
            }
            const quoteIndex = availableQuoteIndices.pop();
            const selectedQuote = quotes[quoteIndex];
            const randomEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
            quoteTextElement.innerHTML = `"${DOMPurify.sanitize(selectedQuote.quote)}" <span class="quote-emoji">${randomEmoji}</span>`;
            quoteAuthorElement.textContent = DOMPurify.sanitize(selectedQuote.author);
        }

        window.updateCharCount = function() {
            document.getElementById('currentCharCount').textContent = document.getElementById('userNameInput').value.length;
        }

        window.submitName = function() {
            let userName = document.getElementById('userNameInput').value.trim();
            const userRole = document.querySelector('input[name="userRole"]:checked').value;
            if (userName === '') userName = 'Guest';
            
            const sanitizedUserName = DOMPurify.sanitize(userName);
            const sanitizedUserRole = DOMPurify.sanitize(userRole);

            localStorage.setItem('userName', sanitizedUserName);
            localStorage.setItem('userRole', sanitizedUserRole);
            
            const actionDescription = `chose the ${sanitizedUserRole} role.`;
            const activityLogRef = dbRef(rtdb, 'userActivityLog');
            push(activityLogRef, {
                userName: sanitizedUserName,
                action: actionDescription,
                timestamp: serverTimestamp() 
            });

            updateWelcomeSection();
            window.closeNamePopup();
        }

        function updateWelcomeSection() {
            const userName = localStorage.getItem('userName') || 'Guest';
            const userRole = localStorage.getItem('userRole') || '';
            document.getElementById('displayedUserName').textContent = userName;
            const roleSticker = document.getElementById('displayedUserRole');
            if (userRole && userRole !== 'Other') {
                roleSticker.textContent = userRole;
                roleSticker.style.display = 'inline-block';
            } else {
                roleSticker.style.display = 'none';
            }
        }

        window.closeNamePopup = function() {
            document.getElementById('namePopupOverlay').classList.remove('active');
        }

        function hideAllViews(container) {
            [...container.children].forEach(el => {
                if (el.id && (el.id.endsWith('-view') || el.classList.contains('coming-soon-section') || el.id === 'bundles-main-container')) {
                    el.style.display = 'none';
                }
            });
            document.querySelectorAll('#sections-view, #lecture-resource-view, #notifications-view, #request-courses-view, #timer-view, #player-view').forEach(v => v.style.display = 'none'); 
            
             document.querySelector('.welcome-banner').style.display = 'none';
             document.querySelector('.quote-section').style.display = 'none';
             document.getElementById('batch-progress-bar-container').style.display = 'none';
        }

        function setFullscreen(isFullscreen) {
            const topNav = document.getElementById('top-navbar');
            const bottomNav = document.getElementById('bottom-navbar');
            document.body.classList.toggle('fullscreen', isFullscreen);
            topNav.classList.toggle('hidden', isFullscreen);
            bottomNav.classList.toggle('hidden', isFullscreen);
        }

        window.showView = function(viewId, context = {}, isPush = true) {
            const mainContent = document.getElementById('main-content');
            hideAllViews(mainContent);

            const viewElement = document.getElementById(viewId);
            if (viewElement) {
                if (['sections-view', 'lecture-resource-view', 'notifications-view', 'request-courses-view', 'timer-view', 'player-view'].includes(viewId)) {
                    setFullscreen(true);
                    viewElement.style.display = 'block'; 
                } else {
                    setFullscreen(false);
                    if (viewElement.classList.contains('coming-soon-section') || viewId === 'about-me-view') {
                       viewElement.style.display = 'flex'; 
                    } else {
                       viewElement.style.display = 'block';
                    }
                }
            }
            
            if (viewId === 'home-view') {
                document.getElementById('home-view').style.display = 'flex';
                document.querySelector('.welcome-banner').style.display = 'flex';
                document.querySelector('.quote-section').style.display = 'block';

                const notificationBanner = document.getElementById('homepage-notification-banner');
                if (notificationBanner.dataset.pending === 'true') {
                    notificationBanner.classList.add('show');
                    notificationBanner.dataset.pending = 'false'; 
                    setTimeout(() => {
                        notificationBanner.classList.remove('show');
                    }, 8000);
                }
            }

            if (isPush) {
                navigationStack.push({ viewId, context });
            }
            window.scrollTo(0, 0);
        }
        
        window.navigateBack = function() {
            const currentState = navigationStack[navigationStack.length - 1];
            
            if (currentState && currentState.viewId === 'player-view' && plyrInstance) {
                const playerContainer = plyrInstance.elements.container;
                const playerWrapper = document.querySelector('#player-view .player-wrapper');

                if (playerContainer && playerWrapper) {
                    const playerLogo = playerContainer.querySelector('.player-logo');
                    if (playerLogo) {
                        playerWrapper.appendChild(playerLogo);
                    }
                    
                    const floatingText = playerContainer.querySelector('#floating-text');
                    if (floatingText) {
                        playerWrapper.appendChild(floatingText);
                    }
                }
                
                plyrInstance.destroy();
                plyrInstance = null;
            }

            if (navigationStack.length > 1) {
                navigationStack.pop();
                const previousState = navigationStack[navigationStack.length - 1];
                window.showView(previousState.viewId, previousState.context, false);

                if (previousState.viewId === 'sections-view') {
                    const { moduleName } = previousState.context;
                    const titleEl = document.getElementById('sections-title');
                    if (titleEl) {
                        titleEl.textContent = DOMPurify.sanitize(moduleName);
                    }
                }

            } else {
                window.showHomeView();
            }
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible-on-scroll');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        function loadAllCategoriesFromFirebase() {
            return new Promise((resolve, reject) => {
                const categoriesRef = dbRef(rtdb, 'categories');
                onValue(categoriesRef, (snapshot) => {
                    allCategoriesData = snapshot.val() || {};
                    const homeViewElement = document.getElementById('home-view');
                    if (homeViewElement && homeViewElement.style.display !== 'none') {
                        renderCategories();
                    }
                    resolve();
                }, (error) => {
                    // console.error("Error fetching categories:", error);
                    reject(error);
                });
            });
        }

        const loadSiteConfigAndApply = async () => {
            const configRef = dbRef(rtdb, 'siteConfig');
            return new Promise((resolve, reject) => {
                onValue(configRef, (snapshot) => {
                    const configData = snapshot.val() || {};
                    window.siteConfig = { ...window.siteConfig, ...configData };
                    const config = window.siteConfig;

                    const skillNeastLogoEl = document.getElementById('skillNeastLogo');
                    if (skillNeastLogoEl) skillNeastLogoEl.src = DOMPurify.sanitize(config.skillNeastLogoUrl);
                    
                    const sliderHeaderLogoEl = document.getElementById('sliderHeaderLogo');
                    if (sliderHeaderLogoEl) sliderHeaderLogoEl.src = DOMPurify.sanitize(config.sliderHeaderPictureUrl);
                    
                    const sliderTelegramChannelLinkEl = document.getElementById('sliderTelegramChannelLink');
                    if (sliderTelegramChannelLinkEl) sliderTelegramChannelLinkEl.href = DOMPurify.sanitize(config.telegramChannelLink);
                    
                    const sliderTelegramGroupLinkEl = document.getElementById('sliderTelegramGroupLink');
                    if (sliderTelegramGroupLinkEl) sliderTelegramGroupLinkEl.href = DOMPurify.sanitize(config.telegramGroupLink);
                    
                    const surpriseBtnEl = document.getElementById('surpriseBtn');
                    if (surpriseBtnEl) surpriseBtnEl.href = DOMPurify.sanitize(config.surpriseButtonLink || '#');
                    
                    const notificationSoundEl = document.getElementById('notification-sound');
                    if (notificationSoundEl) notificationSoundEl.src = DOMPurify.sanitize(config.notificationSoundUrl || '');

                    const telegramContainer = document.getElementById('telegramBannerContainer');
                    if (config.telegramBanner && config.telegramBanner.enabled && telegramContainer) {
                        const card = config.telegramBanner;
                        let channelsHTML = '<div class="channel-list">';
                        card.channels.forEach(channel => {
                            channelsHTML += `<span>${DOMPurify.sanitize(channel)}</span>`;
                        });
                        channelsHTML += '</div>';

                        telegramContainer.innerHTML = `
                            <div class="banner-title">${DOMPurify.sanitize(card.superTitle)}</div>
                            <h2>${DOMPurify.sanitize(card.mainTitle)}</h2>
                            ${channelsHTML}
                            <a href="${DOMPurify.sanitize(card.buttonLink)}" target="_blank" class="click-here-button">${DOMPurify.sanitize(card.buttonText)}</a>
                            <div class="your-support-text">${DOMPurify.sanitize(card.footerText)}</div>
                        `;
                        telegramContainer.style.display = 'flex';
                    } else if (telegramContainer) {
                        telegramContainer.style.display = 'none';
                    }

                    const discoverContainer = document.getElementById('discoverNoticeContainer');
                    if (config.discoverNotice && config.discoverNotice.enabled && discoverContainer) {
                        const card = config.discoverNotice;
                        const noticeId = btoa(card.mainTitle); 
                        discoverContainer.dataset.noticeId = noticeId;
                        
                        let pointsHTML = '<ol>';
                        card.points.forEach(point => {
                            pointsHTML += `<li>${DOMPurify.sanitize(point)}</li>`;
                        });
                        pointsHTML += '</ol>';

                        const userReaction = localStorage.getItem(`reaction_${noticeId}`);

                        const reactionsHTML = `
                            <div class="discover-notice-reactions">
                                <div class="reaction-icon-discover ${userReaction === 'heart' ? 'reacted' : ''}" data-reaction-type="heart"><span class="reaction-emoji">❤️</span><span class="reaction-count">${card.reactions.heart}</span></div>
                                <div class="reaction-icon-discover ${userReaction === 'laugh' ? 'reacted' : ''}" data-reaction-type="laugh"><span class="reaction-emoji">😂</span><span class="reaction-count">${card.reactions.laugh}</span></div>
                                <div class="reaction-icon-discover ${userReaction === 'thumb' ? 'reacted' : ''}" data-reaction-type="thumb"><span class="reaction-emoji">👍</span><span class="reaction-count">${card.reactions.thumb}</span></div>
                                <div class="reaction-icon-discover ${userReaction === 'star' ? 'reacted' : ''}" data-reaction-type="star"><span class="reaction-emoji">🌟</span><span class="reaction-count">${card.reactions.star}</span></div>
                            </div>`;

                        discoverContainer.innerHTML = `
                            <h4>${DOMPurify.sanitize(card.superTitle)}<br>${DOMPurify.sanitize(card.mainTitle)}</h4>
                            ${pointsHTML}
                            ${reactionsHTML}
                        `;
                        discoverContainer.style.display = 'flex';
                        discoverContainer.style.flexDirection = 'column';
                    } else if (discoverContainer) {
                        discoverContainer.style.display = 'none';
                    }
                    resolve(); 
                }, (error) => {
                    // console.error("Error loading site config:", error);
                    reject(error);
                });
            });
        };
        
        window.showHomeView = () => {
            window.showView('home-view');
            renderCategories(); 
            highlightBottomNav('home-nav'); 
        }
        
        function renderCategories() {
            const categoriesGrid = document.getElementById('course-categories-grid');
            if (!categoriesGrid) return;

            categoriesGrid.innerHTML = '';
            
            const sortedCategories = sortItemsByOrder(allCategoriesData);
            
            if (sortedCategories.length === 0) {
                 categoriesGrid.innerHTML = '<p class="text-center text-muted">No courses available yet.</p>';
                 return;
            }

            sortedCategories.forEach(([catId, category]) => {
                if (category.isVisible === false) {
                    return; 
                }

                const categoryItem = document.createElement('div');
                categoryItem.className = 'course-category-item hidden-on-scroll';
                categoryItem.onclick = () => window.showNewBatchesView(catId);
                const imageUrl = DOMPurify.sanitize(category.imageUrl || 'https://via.placeholder.com/90x90/8B5CF6/1F2937?text=Category');
                
                categoryItem.innerHTML = `
                    <div class="image-container">
                        <img src="${imageUrl}" alt="${DOMPurify.sanitize(category.name)}" draggable="false" onerror="this.src='https://via.placeholder.com/90x90/8B5CF6/1F2937?text=Error';">
                    </div>
                    <div class="content-overlay">
                        <span class="category-name">${DOMPurify.sanitize(category.name)}</span>
                    </div>
                `;
                categoriesGrid.appendChild(categoryItem);
                observer.observe(categoryItem);
            });
             if (categoriesGrid.innerHTML === '') {
                categoriesGrid.innerHTML = '<p class="text-center text-muted">No courses available yet.</p>';
            }
        }

        function renderSkeletonBatchCards(containerId, count) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 

            let skeletonHTML = '';
            for (let i = 0; i < count; i++) {
                skeletonHTML += `
                    <div class="skeleton-batch-card">
                        <div class="skeleton-header skeleton-placeholder"></div>
                        <div class="skeleton-body">
                            <div class="skeleton-image skeleton-placeholder"></div>
                            <div class="skeleton-title skeleton-placeholder"></div>
                            <div class="skeleton-price skeleton-placeholder"></div>
                            <div class="skeleton-desc-line skeleton-placeholder"></div>
                            <div class="skeleton-desc-line short skeleton-placeholder"></div>
                            <div class="skeleton-button skeleton-placeholder"></div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = skeletonHTML;
        }

        window.showNewBatchesView = function(categoryId = 'all') {
            window.showView('new-batches-view', { categoryId });
            highlightBottomNav('courses-nav');
            
            renderSkeletonBatchCards('batches-container', 6);
            
            setTimeout(() => {
                let batchesToDisplay = [];

                if (categoryId === 'all') {
                    document.getElementById('new-batches-title').textContent = 'All Courses';
                    const sortedCategories = sortItemsByOrder(allCategoriesData);
                    sortedCategories.forEach(([catKey, cat]) => {
                        if (cat.isVisible !== false && cat.batches) {
                            const sortedBatches = sortItemsByOrder(cat.batches);
                            sortedBatches.forEach(([batchId, batchData]) => {
                                if (batchData.isVisible !== false) {
                                    batchesToDisplay.push({ id: batchId, ...batchData, categoryId: catKey });
                                }
                            });
                        }
                    });
                } else {
                    const selectedCategory = allCategoriesData[categoryId];
                    if (selectedCategory && selectedCategory.isVisible !== false) {
                        document.getElementById('new-batches-title').textContent = DOMPurify.sanitize(selectedCategory.name);
                        if (selectedCategory.batches) {
                            const sortedBatches = sortItemsByOrder(selectedCategory.batches);
                            sortedBatches.forEach(([batchId, batchData]) => {
                                if (batchData.isVisible !== false) {
                                    batchesToDisplay.push({ id: batchId, ...batchData, categoryId: categoryId });
                                }
                            });
                        }
                    } else {
                        document.getElementById('new-batches-title').textContent = 'Category Not Found';
                        document.getElementById('batches-container').innerHTML = '<p class="text-center text-muted">Sorry, this category is not available.</p>';
                        return; 
                    }
                }
                
                displayBatches(batchesToDisplay, 'batches-container');
            }, 500); 
        }

        function displayBatches(batchesToDisplay, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; 

            if (batchesToDisplay.length === 0) {
                if (containerId === 'favorite-batches-container') {
                     document.getElementById('no-favorites-message-view').style.display = 'block';
                } else {
                    container.innerHTML = '<p class="text-center text-muted">No courses found in this section.</p>';
                }
                return;
            }
             if (containerId === 'favorite-batches-container') {
                document.getElementById('no-favorites-message-view').style.display = 'none';
            }
            batchesToDisplay.forEach(batch => {
                const batchCard = document.createElement('div');
                batchCard.className = 'batch-card hidden-on-scroll';
                const isFavorited = window.favorites.includes(batch.id);
                const heartIconClass = isFavorited ? 'fas fa-heart' : 'far fa-heart';
                
                const typeTag = DOMPurify.sanitize(batch.typeTag || 'free');
                const statusTag = DOMPurify.sanitize(batch.statusTag || 'new');

                const typeTagHTML = `<div class="type-tag ${typeTag.toLowerCase()}">${typeTag}</div>`;
                const statusTagHTML = `<div class="status-tag ${statusTag.toLowerCase()}">${statusTag}</div>`;
                
                let languageTagHTML = '';
                if (batch.language) {
                    languageTagHTML = `<div class="language-tag">${DOMPurify.sanitize(batch.language)}</div>`;
                }

                const price = parseFloat(batch.price) || 0;
                let priceHTML = '';
                if (price > 0) {
                    priceHTML = `<div class="batch-price paid">₹ ${price}</div>`;
                } else {
                    priceHTML = `<div class="batch-price">FREE</div>`;
                }

                let descriptionHTML = '';
                if (batch.description) {
                    const descItems = DOMPurify.sanitize(batch.description).split(/\s*[;\n]\s*/).filter(line => line.trim() !== '');
                    descriptionHTML = `<div class="batch-description-list">` + 
                        descItems.map((item, index) => `<div class="batch-description-item" style="animation-delay: ${index * 0.1}s">
                                                            <i class="fas fa-check-circle"></i>
                                                            <span>${item}</span>
                                                         </div>`).join('') + 
                        `</div>`;
                }

                batchCard.innerHTML = `
                    <div class="batch-card-header" style="background: ${DOMPurify.sanitize(batch.headerColor || 'var(--accent-gradient)')};">
                        <span class="batch-title-text">${DOMPurify.sanitize(batch.title)}</span>
                        <div class="icons">
                            ${typeTagHTML}
                            <i class="${heartIconClass}" onclick="event.stopPropagation(); window.toggleFavorite('${DOMPurify.sanitize(batch.id)}', this);"></i>
                            <i class="fas fa-share-alt" onclick="event.stopPropagation(); window.shareBatch('${DOMPurify.sanitize(batch.title)}', '${DOMPurify.sanitize(batch.description)}');"></i>
                        </div>
                    </div>
                    <div class="batch-card-body">
                        <div class="batch-image-container">
                            ${statusTagHTML}
                            ${languageTagHTML} 
                            <img src="${DOMPurify.sanitize(batch.thumbnail)}" alt="${DOMPurify.sanitize(batch.title)}" draggable="false" onerror="this.src='https://via.placeholder.com/200x150/1F2937/FFFFFF?text=Image';">
                        </div>
                        <div class="batch-title">${DOMPurify.sanitize(batch.title)}</div>
                        ${priceHTML}
                        ${descriptionHTML}
                        <button class="lets-roar-button" onclick="window.handleBatchClick('${DOMPurify.sanitize(batch.categoryId)}', '${DOMPurify.sanitize(batch.id)}')">LET'S ROAR 🚀🔥</button>
                    </div>
                `;
                container.appendChild(batchCard);
                observer.observe(batchCard);
            });
        }

        window.handleBatchClick = function(categoryId, batchId) {
            const category = allCategoriesData[categoryId];
            const batch = category?.batches?.[batchId];
            
            if (!category || category.isVisible === false || !batch || batch.isVisible === false) {
                alert('This course is currently unavailable.');
                return;
            }

            const price = parseFloat(batch.price) || 0;
            const hasRedirectLink = batch.redirectLink && batch.redirectLink.trim() !== '';

            if (price > 0 || (batch.typeTag === 'free' && hasRedirectLink)) {
                if (hasRedirectLink) {
                    window.open(DOMPurify.sanitize(batch.redirectLink), '_blank');
                } else {
                    alert('Configuration error: No redirect link found for this batch.');
                }
            } else {
                window.showSectionsView(categoryId, batchId, batch.modules, batch.title);
            }
        }

        window.filterBatches = function() {
            const searchTerm = document.getElementById('batchSearchInput').value.toLowerCase();
            const { categoryId } = navigationStack[navigationStack.length - 1].context;
            let allBatches = [];
            if (categoryId === 'all') {
                const sortedCategories = sortItemsByOrder(allCategoriesData);
                sortedCategories.forEach(([catKey, cat]) => {
                    if (cat.isVisible !== false && cat.batches) {
                        const sortedBatches = sortItemsByOrder(cat.batches);
                        sortedBatches.forEach(([batchId, batchData]) => {
                            if (batchData.isVisible !== false) {
                                allBatches.push({ id: batchId, ...batchData, categoryId: catKey });
                            }
                        });
                    }
                });
            } else {
                const selectedCategory = allCategoriesData[categoryId];
                if (selectedCategory && selectedCategory.isVisible !== false && selectedCategory.batches) {
                    const sortedBatches = sortItemsByOrder(selectedCategory.batches);
                    sortedBatches.forEach(([batchId, batchData]) => {
                        if (batchData.isVisible !== false) {
                            allBatches.push({ id: batchId, ...batchData, categoryId: categoryId });
                        }
                    });
                }
            }
            const filtered = allBatches.filter(b => DOMPurify.sanitize(b.title).toLowerCase().includes(searchTerm));
            displayBatches(filtered, 'batches-container');
        }

        window.toggleFavorite = function(batchId, iconElement) {
            const index = window.favorites.indexOf(batchId);
            if (index > -1) {
                window.favorites.splice(index, 1);
                iconElement.classList.replace('fas', 'far');
            } else {
                window.favorites.push(batchId);
                iconElement.classList.replace('far', 'fas');
            }
            localStorage.setItem('favorites', JSON.stringify(window.favorites));
            renderFavoritesSectionHomeCard();
            if (navigationStack.length > 0 && navigationStack[navigationStack.length-1].viewId === 'favorites-view') {
                window.showFavoritesView();
            }
        }

        function renderFavoritesSectionHomeCard() {
            document.getElementById('favorites-count').textContent = `${window.favorites.length} Batches`;
        }

        window.showFavoritesView = function() {
            window.showView('favorites-view');
            highlightBottomNav('home-nav');
            
            let favBatches = [];
             if (Object.keys(allCategoriesData).length > 0) {
                const sortedCategories = sortItemsByOrder(allCategoriesData);
                sortedCategories.forEach(([catId, category]) => {
                    if(category.isVisible !== false && category.batches) {
                        const sortedBatches = sortItemsByOrder(category.batches);
                        sortedBatches.forEach(([batchId, batchData]) => {
                            if((batchData.isVisible !== false) && window.favorites.includes(batchId)) {
                                favBatches.push({id: batchId, ...batchData, categoryId: catId});
                            }
                        });
                    }
                });
             }
            displayBatches(favBatches, 'favorite-batches-container');
        }

        // --- UPDATED: RECURSIVE FUNCTION TO CALCULATE COUNTS ---
        function calculateModuleCounts(module) {
            let counts = { lectures: 0, resources: 0, subModules: 0 };
            if (!module) return counts;

            // Count direct items
            if (module.lectures) {
                counts.lectures += Object.values(module.lectures).filter(item => !item.isSubModule).length;
                counts.subModules += Object.values(module.lectures).filter(item => item.isSubModule).length;
            }
            if (module.resources) {
                counts.resources += Object.values(module.resources).filter(item => !item.isSubModule).length;
                counts.subModules += Object.values(module.resources).filter(item => item.isSubModule).length;
            }

            // Recursively count in sub-modules
            const allContent = { ...(module.lectures || {}), ...(module.resources || {}) };
            for(const itemId in allContent) {
                const item = allContent[itemId];
                if(item.isSubModule) {
                    const subCounts = calculateModuleCounts(item);
                    counts.lectures += subCounts.lectures;
                    counts.resources += subCounts.resources;
                }
            }
            return counts;
        }

        window.showSectionsView = function(categoryId, batchId, modulesToShow, viewTitle) {
            window.showView('sections-view', { categoryId, batchId, modules: modulesToShow, moduleName: viewTitle });

            if (window.favorites.includes(batchId)) {
                document.getElementById('batch-progress-bar-container').style.display = 'flex';
                updateBatchProgressBar(categoryId, batchId);
            } else {
                document.getElementById('batch-progress-bar-container').style.display = 'none';
            }

            document.getElementById('sections-title').textContent = DOMPurify.sanitize(viewTitle);
            const container = document.getElementById('sections-container');
            container.innerHTML = '';

            if (modulesToShow && Object.keys(modulesToShow).length > 0) {
                const sortedModules = sortItemsByOrder(modulesToShow);
                sortedModules.forEach(([moduleId, module]) => {
                    const { lectures: lectureCount, resources: resourcesCount, subModules: folderCount } = calculateModuleCounts(module);

                    const sectionItem = document.createElement('div');
                    sectionItem.className = 'section-item hidden-on-scroll';
                    sectionItem.onclick = () => window.showLectureResourceView(categoryId, batchId, moduleId, module);

                    let countsHTML = `<span><i class="fas fa-video"></i> ${lectureCount} Lectures</span>
                                      <span><i class="fas fa-file-alt"></i> ${resourcesCount} Resources</span>`;
                    if(folderCount > 0) {
                        countsHTML += `<span><i class="fas fa-folder-open"></i> ${folderCount} Folders</span>`;
                    }
                    
                    sectionItem.innerHTML = `
                        <span class="section-name">${DOMPurify.sanitize(module.name)}</span>
                        <div class="section-counts">${countsHTML}</div>
                    `;
                    container.appendChild(sectionItem);
                    observer.observe(sectionItem);
                });
            } else {
                container.innerHTML = '<p class="text-center text-muted">No modules found.</p>';
            }
        }
        
        window.showLectureResourceView = function(categoryId, batchId, moduleId, moduleData) {
            if (!moduleData) {
                alert('This content is currently unavailable.');
                window.navigateBack(); 
                return;
            }
            
            window.showView('lecture-resource-view', { categoryId, batchId, moduleId, moduleData });
            
            document.getElementById('lecture-resource-title').textContent = DOMPurify.sanitize(moduleData.name);
            renderLectures(categoryId, batchId, moduleId, moduleData);
            renderResources(categoryId, batchId, moduleId, moduleData);
            switchTab('lectures');
        }

        function renderContent(container, contentData, categoryId, batchId, moduleId) {
             if (!contentData || Object.keys(contentData).length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No items in this section.</p>';
                return;
             }
             const sortedContent = sortItemsByOrder(contentData);

             sortedContent.forEach(([itemId, item]) => {
                const isCompleted = getItemProgressForModule(moduleId).includes(itemId);
                
                if (item.isSubModule) { // Render Sub-module
                    const subModuleItem = document.createElement('div');
                    subModuleItem.className = `lecture-item hidden-on-scroll`; // Using lecture-item style for consistency
                    subModuleItem.onclick = () => window.showLectureResourceView(categoryId, batchId, itemId, item);
                    subModuleItem.innerHTML = `
                        <div class="item-info">
                             <div class="lecture-thumbnail" style="display:flex; align-items:center; justify-content:center; background-color: var(--primary-dark);">
                                <i class="fas fa-folder fa-2x" style="color:var(--highlight-gold);"></i>
                            </div>
                            <h3 class="item-name">${DOMPurify.sanitize(item.name)}</h3>
                        </div>`;
                    container.appendChild(subModuleItem);
                } else if (item.link) { // Render Lecture or Resource
                    if (container.id === 'lectures-container') { // Render Lecture
                        const lectureItem = document.createElement('div');
                        lectureItem.className = `lecture-item hidden-on-scroll ${isCompleted ? 'completed' : ''}`;
                        const thumbnailUrl = DOMPurify.sanitize(item.thumbnail || allCategoriesData[categoryId].batches[batchId].defaultLectureThumbnail || window.siteConfig.defaultLectureThumbnail);
                        const fallbackThumbnailUrl = DOMPurify.sanitize(window.siteConfig.defaultLectureThumbnail);

                        lectureItem.innerHTML = `
                            <div class="item-info" style="cursor: pointer;" onclick="window.showPlayerView('${categoryId}', '${batchId}', '${moduleId}', '${itemId}')">
                                <div class="lecture-thumbnail">
                                    <img src="${thumbnailUrl}" alt="${DOMPurify.sanitize(item.name)}" draggable="false" onerror="this.src='${fallbackThumbnailUrl}';">
                                </div>
                                <h3 class="item-name">${DOMPurify.sanitize(item.name)}</h3>
                            </div>
                            <input type="checkbox" class="progress-checkbox" data-module-id="${moduleId}" data-item-id="${itemId}" ${isCompleted ? 'checked' : ''} onchange="window.toggleItemProgress(this)">`;
                        container.appendChild(lectureItem);
                    } else { // Render Resource
                        let iconClass = 'fa-file';
                        const type = item.type ? item.type.toLowerCase() : '';
                        if (type === 'pdf') iconClass = 'fa-file-pdf';
                        else if (type === 'zip' || type === 'rar') iconClass = 'fa-file-archive';
                        else if (type === 'txt') iconClass = 'fa-file-alt';

                        const resourceItem = document.createElement('div');
                        resourceItem.className = `resource-item hidden-on-scroll ${isCompleted ? 'completed' : ''}`;
                        resourceItem.innerHTML = `
                            <a href="${DOMPurify.sanitize(item.link)}" target="_blank" class="item-info">
                                <i class="fas ${iconClass} resource-icon"></i>
                                <span class="item-name">${DOMPurify.sanitize(item.name)}</span>
                            </a>
                            <input type="checkbox" class="progress-checkbox" data-module-id="${moduleId}" data-item-id="${itemId}" ${isCompleted ? 'checked' : ''} onchange="window.toggleItemProgress(this)">`;
                        container.appendChild(resourceItem);
                    }
                }
                 observer.observe(container.lastChild);
             });
        }


        function renderLectures(categoryId, batchId, moduleId, moduleData) {
            const container = document.getElementById('lectures-container');
            container.innerHTML = '';
            renderContent(container, moduleData.lectures, categoryId, batchId, moduleId);
        }

        function renderResources(categoryId, batchId, moduleId, moduleData) {
            const container = document.getElementById('resources-container');
            container.innerHTML = '';
            renderContent(container, moduleData.resources, categoryId, batchId, moduleId);
        }


        window.switchTab = function(tabName) {
            const lecturesContainer = document.getElementById('lectures-container');
            const resourcesContainer = document.getElementById('resources-container');
            const lecturesBtn = document.getElementById('lectures-tab-btn');
            const resourcesBtn = document.getElementById('resources-tab-btn');

            if (tabName === 'lectures') {
                lecturesContainer.style.display = 'flex';
                resourcesContainer.style.display = 'none';
                lecturesBtn.classList.add('active');
                resourcesBtn.classList.remove('active');
            } else {
                lecturesContainer.style.display = 'none';
                resourcesContainer.style.display = 'flex';
                lecturesBtn.classList.remove('active');
                resourcesBtn.classList.add('active');
            }
        }
        
        window.highlightBottomNav = function(activeId) {
            document.querySelectorAll('.bottom-navbar .nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(activeId).classList.add('active');
        }

        window.handleRedirect = function(type) {
            const overlay = document.getElementById('redirect-popup-overlay');
            const titleEl = document.getElementById('redirect-popup-title');
            const textEl = document.getElementById('redirect-popup-text');
            const config = window.siteConfig;
            let url, sectionName, description;

            if (type === 'bundles') {
                url = config.bundlesRedirectUrl;
                sectionName = "Course Bundles";
                description = "You're being redirected to our exclusive bundles section. Get ready for awesome deals!";
            } else if (type === 'pdfs') {
                url = config.pdfsRedirectUrl;
                sectionName = "PDF Section";
                description = "Heading to our PDF library. Find all the notes and resources you need!";
            }

            if (!url || url === '#') {
                alert(`Redirect link for ${sectionName} is not configured yet.`);
                return;
            }

            titleEl.textContent = `Going to ${sectionName}...`;
            textEl.textContent = description;
            overlay.classList.add('show');

            setTimeout(() => {
                window.open(url, '_blank');
                overlay.classList.remove('show');
            }, 2500);
        }

        window.showAboutMeView = function() {
            window.showView('about-me-view');
            highlightBottomNav('about-me-nav');
        }

        window.openSliderMenu = function() {
            document.getElementById('sliderMenuOverlay').classList.add('active');
            document.getElementById('sliderMenu').classList.add('active');
        }

        window.closeSliderMenu = function() {
            document.getElementById('sliderMenuOverlay').classList.remove('active');
            document.getElementById('sliderMenu').classList.remove('active');
        }

        window.shareApp = function() {
            if (navigator.share) {
                navigator.share({
                    title: 'SkillNeast App',
                    text: 'Master new skills with SkillNeast!',
                    url: window.location.href 
                });
            } else {
                alert('Share feature not supported.');
            }
        }
        
        window.shareBatch = function(title, description) {
             if (navigator.share) {
                navigator.share({
                    title: `Check out: ${DOMPurify.sanitize(title)} on SkillNeast!`,
                    text: `${DOMPurify.sanitize(description)}\n\nLearn more at SkillNeast!`,
                    url: window.location.href
                });
            } else {
                alert('Share feature not supported.');
            }
        }

        function getItemProgressForModule(moduleId) {
            const progress = JSON.parse(localStorage.getItem('itemProgress')) || {};
            return progress[moduleId] || [];
        }
        
        window.toggleItemProgress = function(checkbox) {
            const { moduleId, itemId } = checkbox.dataset;
            let progress = JSON.parse(localStorage.getItem('itemProgress')) || {};
            if (!progress[moduleId]) {
                progress[moduleId] = [];
            }

            const itemElement = checkbox.closest('.lecture-item, .resource-item');

            if (checkbox.checked) {
                if (!progress[moduleId].includes(itemId)) {
                    progress[moduleId].push(itemId);
                }
                itemElement.classList.add('completed');
            } else {
                progress[moduleId] = progress[moduleId].filter(id => id !== itemId);
                itemElement.classList.remove('completed');
            }
            localStorage.setItem('itemProgress', JSON.stringify(progress));

            const currentState = navigationStack[navigationStack.length - 1];
            if (currentState && (currentState.viewId === 'lecture-resource-view' || currentState.viewId === 'sections-view')) {
                const { categoryId, batchId } = currentState.context;
                updateBatchProgressBar(categoryId, batchId);
            }
        };

        function updateBatchProgressBar(categoryId, batchId) {
            const batch = allCategoriesData[categoryId]?.batches?.[batchId];
            if (!batch) return;

            let totalItems = 0;
            let completedItems = 0;
            
            if (batch.modules) {
                for (const moduleId in batch.modules) {
                    const module = batch.modules[moduleId];
                    const { lectures, resources } = calculateModuleCounts(module);
                    totalItems += lectures + resources;
                    
                    const completedInModule = getItemProgressForModule(moduleId);
                    completedItems += completedInModule.length;
                }
            }

            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            document.getElementById('progress-bar-title').textContent = `${DOMPurify.sanitize(batch.title)} Progress`;
            document.getElementById('progress-bar-fill').style.width = `${percentage}%`;
            document.getElementById('progress-bar-percentage').textContent = `${percentage}%`;
        }

        function listenForHomepageNotifications() {
            const notificationsRef = dbRef(rtdb, 'notifications');
            onValue(notificationsRef, (snapshot) => {
                const notification = snapshot.val();
                if (notification && notification.timestamp && notification.timestamp > (JSON.parse(localStorage.getItem('lastHomepageNotificationTimestamp')) || 0)) {
                    showHomepageNotificationBanner(notification);
                    localStorage.setItem('lastHomepageNotificationTimestamp', notification.timestamp);
                }
            }, (error) => {});
        }
        
        function showHomepageNotificationBanner(notification) {
            const { type, batchName, categoryId, batchId, icon, message } = notification;
            const banner = document.getElementById('homepage-notification-banner');
            
            let title = '';
            let iconClass = icon || 'fas fa-info-circle'; 
            let contentText = message || ''; 
            
            if (type === 'new_batch') {
                title = 'New Batch Added! 🥰✨';
                if (!message) contentText = `${DOMPurify.sanitize(batchName)}`;
                if (!icon) iconClass = 'fas fa-plus-circle';
            } else if (type === 'update_batch') {
                title = 'Batch Updated! 🥰✨';
                if (!message) contentText = `${DOMPurify.sanitize(batchName)}`;
                if (!icon) iconClass = 'fas fa-check-circle';
            }
            else {
                if (!title) title = DOMPurify.sanitize(notification.title || 'Notification');
                if (!contentText) contentText = DOMPurify.sanitize(message || 'You have a new update.');
            }
            
            banner.innerHTML = `
                <div class="notification-icon"><i class="${iconClass}"></i></div>
                <div class="notification-content">
                    <div class="notification-title">${DOMPurify.sanitize(title)}</div>
                    <p class="notification-text">${DOMPurify.sanitize(contentText)}</p>
                </div>
                <div class="notification-action">
                    <button class="view-details-btn" onclick="window.viewHomepageNotificationDetails('${DOMPurify.sanitize(type)}', '${DOMPurify.sanitize(categoryId || '')}', '${DOMPurify.sanitize(batchId || '')}')">View Details</button>
                </div>
            `;
            
            if(navigationStack.length > 0 && navigationStack[navigationStack.length-1].viewId === 'home-view') {
                 banner.classList.add('show');
                 banner.dataset.pending = 'false'; 
                 setTimeout(() => banner.classList.remove('show'), 8000);
            } else {
                banner.dataset.pending = 'true';
            }
        }
        
        window.viewHomepageNotificationDetails = function(type, categoryId, batchId) {
             document.getElementById('homepage-notification-banner').classList.remove('show');
             if (type === 'new_batch' || type === 'update_batch') {
                 window.handleBatchClick(categoryId, batchId);
             }
             else {
                 alert('This notification has no direct action.');
             }
        }

        function listenForTopBarNotifications() {
            if (!currentUserId) {
                return;
            }

            const personalNotifsRef = dbRef(rtdb, `notificationsV2/personal`);
            onValue(personalNotifsRef, (snapshot) => {
                const fetchedNotifs = snapshot.val() || {};
                allPersonalNotifications = fetchedNotifs; 
                updateUnreadNotificationCountBadge();
                if (navigationStack.length > 0 && navigationStack[navigationStack.length - 1]?.viewId === 'notifications-view' && activeNotificationTab === 'personal') {
                    renderNotificationList(allPersonalNotifications, document.getElementById('personal-notifications-container'), 'personal');
                }
            }, (error) => {}); 

            const announcementsRef = dbRef(rtdb, `notificationsV2/announcements`);
            onValue(announcementsRef, (snapshot) => {
                const fetchedAnnouncements = snapshot.val() || {};
                allAnnouncements = fetchedAnnouncements; 
                updateUnreadNotificationCountBadge();
                if (navigationStack.length > 0 && navigationStack[navigationStack.length - 1]?.viewId === 'notifications-view' && activeNotificationTab === 'announcements') {
                    renderNotificationList(allAnnouncements, document.getElementById('announcements-notifications-container'), 'announcements');
                }
            }, (error) => {}); 
        }

        function updateUnreadNotificationCountBadge() {
            if (!currentUserId) {
                document.getElementById('topNotificationBadge').classList.remove('active');
                return;
            }

            let newUnreadCount = 0;
            const notificationSound = document.getElementById('notification-sound');
            const lastPlayedTimestamp = parseInt(localStorage.getItem('lastTopNotificationSoundPlayed') || '0', 10); 
            let playSound = false;

            Object.values(allPersonalNotifications).forEach(notif => {
                if (!notif.readBy || !notif.readBy[currentUserId]) {
                    newUnreadCount++;
                    if (notif.timestamp && notif.timestamp > lastPlayedTimestamp && window.siteConfig.notificationSoundUrl) {
                        playSound = true;
                    }
                }
            });

            Object.values(allAnnouncements).forEach(notif => {
                if (!notif.readBy || !notif.readBy[currentUserId]) {
                    newUnreadCount++;
                    if (notif.timestamp && notif.timestamp > lastPlayedTimestamp && window.siteConfig.notificationSoundUrl) {
                        playSound = true;
                    }
                }
            });

            if (newUnreadCount > 0) {
                document.getElementById('topNotificationBadge').textContent = newUnreadCount;
                document.getElementById('topNotificationBadge').classList.add('active');
            } else {
                document.getElementById('topNotificationBadge').classList.remove('active');
            }

            if (playSound) {
                if (notificationSound && window.siteConfig.notificationSoundUrl) {
                    notificationSound.play().catch(e => {}); 
                    localStorage.setItem('lastTopNotificationSoundPlayed', Date.now().toString()); 
                }
            }

            unreadNotificationCount = newUnreadCount; 
        }

        window.showNotificationsView = function() {
            window.showView('notifications-view');
            window.switchNotificationTab(activeNotificationTab);
        }

        window.switchNotificationTab = function(tabType) {
            activeNotificationTab = tabType;
            const personalContainer = document.getElementById('personal-notifications-container');
            const announcementsContainer = document.getElementById('announcements-notifications-container');
            const personalBtn = document.getElementById('personal-tab-btn');
            const announcementsBtn = document.getElementById('announcements-tab-btn');

            if (tabType === 'personal') {
                personalContainer.style.display = 'block';
                announcementsContainer.style.display = 'none';
                personalBtn.classList.add('active');
                announcementsBtn.classList.remove('active');
                renderNotificationList(allPersonalNotifications, personalContainer, 'personal');
            } else {
                personalContainer.style.display = 'none';
                announcementsContainer.style.display = 'block';
                personalBtn.classList.remove('active');
                announcementsBtn.classList.add('active');
                renderNotificationList(allAnnouncements, announcementsContainer, 'announcements');
            }
        }

        function getYouTubeVideoId(url) {
            if (!url) return null;
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/i;
            const match = url.match(youtubeRegex);
            return (match && match[1]) ? match[1] : null;
        }

        function renderNotificationList(notificationsData, containerElement, type) {
            containerElement.innerHTML = '';
            const sortedNotifications = Object.keys(notificationsData)
                .map(id => ({ id, ...notificationsData[id] }))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 

            if (sortedNotifications.length === 0) {
                containerElement.innerHTML = `<p class="text-center text-muted" style="padding: 20px;">No ${type} notifications yet.</p>`;
                return;
            }

            sortedNotifications.forEach(notif => {
                const isRead = notif.readBy && notif.readBy[currentUserId];
                const notifItem = document.createElement('div');
                notifItem.className = `notification-item hidden-on-scroll ${isRead ? 'is-read' : ''}`;
                notifItem.onclick = () => window.markNotificationAsRead(notif.id, type, notif.button?.link); 

                const date = notif.timestamp ? new Date(notif.timestamp) : null;
                const formattedDate = date ? date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '';
                const formattedTime = date ? date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : '';
                const dateTimeString = `${formattedDate} ${formattedTime}`.trim();

                let buttonHtml = '';
                let thumbnailOrIconHtml = ''; 

                const youtubeVideoId = getYouTubeVideoId(notif.button?.link);

                if (youtubeVideoId) {
                    thumbnailOrIconHtml = `<img src="https://img.youtube.com/vi/${youtubeVideoId}/mqdefault.jpg" alt="Video Thumbnail" class="notification-thumbnail">`;
                } else {
                    const notificationIconClass = DOMPurify.sanitize(notif.icon || 'fa-info-circle');
                    thumbnailOrIconHtml = `<div class="notification-item-icon"><i class="fas ${notificationIconClass}"></i></div>`;
                }


                if (notif.button && notif.button.text && notif.button.link) {
                    const buttonLink = DOMPurify.sanitize(notif.button.link);
                    const buttonTarget = buttonLink.startsWith('#') ? '_self' : '_blank'; 
                    buttonHtml = `
                        <div class="notification-button-wrapper">
                            <a href="${buttonLink}" class="notification-button" target="${buttonTarget}" onclick="event.stopPropagation(); window.handleNotificationButtonClick('${buttonLink}', '${buttonTarget}');">
                                ${DOMPurify.sanitize(notif.button.text)}
                            </a>
                        </div>
                    `;
                }

                notifItem.innerHTML = `
                    ${thumbnailOrIconHtml}
                    <div class="notification-content">
                        <div class="notification-title">${DOMPurify.sanitize(notif.title)}</div>
                        <div class="notification-text">${DOMPurify.sanitize(notif.content)}</div>
                        ${buttonHtml}
                        <div class="notification-timestamp">${dateTimeString}</div>
                    </div>
                `;
                containerElement.appendChild(notifItem);
                observer.observe(notifItem);
            });
        }

        window.markNotificationAsRead = async function(notificationId, type, link = null) {
            if (!currentUserId) {
                return;
            }

            const notifRef = dbRef(rtdb, `notificationsV2/${type}/${notificationId}/readBy/${currentUserId}`);
            try {
                await set(notifRef, true);
            } catch (error) {
            }

            if (link) {
                window.handleNotificationButtonClick(link);
            }
        }

        window.handleNotificationButtonClick = function(link, target) {
            if (link === '#reload') {
                location.reload();
            } else {
                window.open(DOMPurify.sanitize(link), DOMPurify.sanitize(target));
            }
        }

        window.markAllNotificationsAsRead = async function() {
            if (!currentUserId) {
                alert("Please log in to mark notifications as read."); 
                return;
            }

            const notificationsToMark = activeNotificationTab === 'personal' ? allPersonalNotifications : allAnnouncements;
            const updates = {};
            let countMarked = 0;

            for (const notifId in notificationsToMark) {
                if (notificationsToMark.hasOwnProperty(notifId)) {
                    const notif = notificationsToMark[notifId];
                    if (!notif.readBy || !notif.readBy[currentUserId]) {
                        updates[`notificationsV2/${activeNotificationTab}/${notifId}/readBy/${currentUserId}`] = true;
                        countMarked++;
                    }
                }
            }

            if (countMarked > 0) {
                try {
                    await update(dbRef(rtdb), updates);
                } catch (error) {
                    alert("Failed to mark all notifications as read.");
                }
            } else {
                alert("No unread notifications in this section.");
            }
        }

        window.showRequestCoursesView = function() {
            window.showView('request-courses-view');
            window.closeSliderMenu(); 
            loadAndRenderRequestedCourses(); 
        }

        function listenForRequestedCourses() {
            const requestedCoursesRef = dbRef(rtdb, 'requestedCourses');
            onValue(requestedCoursesRef, (snapshot) => {
                allRequestedCourses = snapshot.val() || {};
                if (navigationStack.length > 0 && navigationStack[navigationStack.length - 1]?.viewId === 'request-courses-view') {
                    renderRequestedCoursesList(allRequestedCourses);
                }
            }, (error) => {});
        }

        function loadAndRenderRequestedCourses() {
            renderRequestedCoursesList(allRequestedCourses);
        }

        function renderRequestedCoursesList(coursesData) {
            const container = document.getElementById('request-list-container');
            container.innerHTML = ''; 

            const sortedCourses = Object.keys(coursesData)
                .map(id => ({ id, ...coursesData[id] }))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 

            if (sortedCourses.length === 0) {
                container.innerHTML = `<p class="text-center text-muted" style="padding: 20px;">No requested courses found yet.</p>`;
                return;
            }

            sortedCourses.forEach(course => {
                if (course.enabled === false) {
                    return; 
                }

                const currentUserReaction = course.reactions ? course.reactions[currentUserId] : null;
                const reactionCounts = {};
                if (course.reactions) {
                    for (const userId in course.reactions) {
                        const emojiType = course.reactions[userId];
                        reactionCounts[emojiType] = (reactionCounts[emojiType] || 0) + 1;
                    }
                }

                let featuresHtml = '';
                if (course.features && Array.isArray(course.features) && course.features.length > 0) {
                    featuresHtml = `<ul class="request-features-list">` +
                        course.features.map(feature => `<li><i class="fas fa-check-circle"></i> ${DOMPurify.sanitize(feature)}</li>`).join('') +
                        `</ul>`;
                }

                let buttonHtml = '';
                if (course.button && course.button.text && course.button.link) {
                    const buttonLink = DOMPurify.sanitize(course.button.link);
                    const buttonTarget = DOMPurify.sanitize(course.button.target || '_blank');
                    buttonHtml = `
                        <a href="${buttonLink}" class="request-button" target="${buttonTarget}" onclick="event.stopPropagation(); window.handleRequestButtonClick('${buttonLink}', '${buttonTarget}');">
                            ${DOMPurify.sanitize(course.button.text)}
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    `;
                }

                let reactionsHtml = `<div class="request-reactions-container">`;
                reactionEmojis.forEach(reactionEmoji => { 
                    const count = reactionCounts[reactionEmoji.type] || 0;
                    const isActive = currentUserReaction === reactionEmoji.type;
                    reactionsHtml += `
                        <button class="reaction-icon-request ${isActive ? 'reacted-' + reactionEmoji.type : ''}" 
                                data-emoji-type="${reactionEmoji.type}" 
                                onclick="event.stopPropagation(); window.toggleRequestReaction('${course.id}', '${reactionEmoji.type}', this);">
                            ${reactionEmoji.emoji}
                            <span class="reaction-count">${count}</span>
                        </button>
                    `;
                });
                reactionsHtml += `</div>`;


                const requestCard = document.createElement('div');
                requestCard.className = 'request-card hidden-on-scroll';

                const defaultRequestImage = 'https://via.placeholder.com/400x180/1F2937/FFFFFF?text=REQUEST+COURSE';
                const imageUrl = DOMPurify.sanitize(course.imageUrl || defaultRequestImage);

                requestCard.innerHTML = `
                    <div class="request-image-container" onclick="window.showFullImageViewer('${imageUrl}');">
                        <img src="${imageUrl}" alt="${DOMPurify.sanitize(course.title)}" 
                             onerror="this.onerror=null;this.src='${defaultRequestImage}';this.classList.add('error-fallback');">
                    </div>
                    <div class="request-card-body">
                        <h3 class="request-card-title">${DOMPurify.sanitize(course.title)}</h3>
                        <p class="request-card-description">${DOMPurify.sanitize(course.description || '')}</p>
                        ${featuresHtml}
                        <div class="request-card-actions">
                            ${buttonHtml}
                            ${reactionsHtml}
                        </div>
                    </div>
                `;
                container.appendChild(requestCard);
                observer.observe(requestCard);
            });
            if (container.innerHTML === '') { 
                container.innerHTML = `<p class="text-center text-muted" style="padding: 20px;">No requested courses found yet.</p>`;
            }
        }

        window.toggleRequestReaction = async function(courseId, emojiType, reactionButtonElement) {
            if (!currentUserId) {
                alert("Please log in to react to a course request.");
                return;
            }

            const courseRef = dbRef(rtdb, `requestedCourses/${courseId}`);
            const userReactionPath = `reactions/${currentUserId}`;

            try {
                const snapshot = await get(child(courseRef, userReactionPath));
                const currentReaction = snapshot.val(); 

                const updates = {};
                
                if (currentReaction === emojiType) {
                    updates[userReactionPath] = null; 
                } else {
                    updates[userReactionPath] = emojiType; 
                }

                await update(courseRef, updates); 
            } catch (error) {
                alert("Failed to update reaction. Please try again.");
            }
        }

        window.handleRequestButtonClick = function(link, target) {
            if (link.startsWith('#')) {
                if (link === '#reload') {
                    location.reload();
                } else {
                    alert(`Requested action for ${link} coming soon!`);
                }
            } else {
                window.open(link, target);
            }
        }

        window.showFullImageViewer = function(imageUrl) {
            const imageViewerOverlay = document.getElementById('imageViewerOverlay');
            const fullViewerImage = document.getElementById('fullViewerImage');
            
            if (imageViewerOverlay && fullViewerImage) {
                fullViewerImage.src = DOMPurify.sanitize(imageUrl);
                imageViewerOverlay.style.display = 'flex'; 
                document.body.style.overflow = 'hidden'; 
            }
        }

        window.closeFullImageViewer = function() {
            const imageViewerOverlay = document.getElementById('imageViewerOverlay');
            if (imageViewerOverlay) {
                imageViewerOverlay.style.display = 'none'; 
                document.body.style.overflow = 'auto'; 
                document.getElementById('fullViewerImage').src = ''; 
            }
        }
        
        function initSwipeNavigation() {
            const lectureResourceView = document.getElementById('lecture-resource-view');
            
            lectureResourceView.addEventListener('touchstart', e => {
                touchstartX = e.changedTouches[0].screenX;
            }, { passive: true });

            lectureResourceView.addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                handleSwipeGesture();
            });
        }
        
        function handleSwipeGesture() {
            const lecturesBtn = document.getElementById('lectures-tab-btn');
            const resourcesBtn = document.getElementById('resources-tab-btn');
            const swipeThreshold = 50; 

            if (touchendX < touchstartX - swipeThreshold) {
                if (lecturesBtn.classList.contains('active')) {
                    window.switchTab('resources');
                }
            }

            if (touchendX > touchstartX + swipeThreshold) {
                if (resourcesBtn.classList.contains('active')) {
                    window.switchTab('lectures');
                }
            }
        }

        function getVideoUniqueId(categoryId, batchId, moduleId, lectureId) {
            // *** UPDATED: To handle nested modules, we need a more robust ID ***
            const currentState = navigationStack[navigationStack.length-1];
            const contextPath = currentState?.context?.path || `${categoryId}/${batchId}/${moduleId}`;
            return `${contextPath.replace(/\//g, '_')}_${lectureId}`.replace(/[^a-zA-Z0-9_]/g, '');
        }
        
        // *** UPDATED: To handle getting lecture data from nested structures ***
        window.showPlayerView = (categoryId, batchId, moduleId, lectureId) => {
            // This needs a robust way to find the lecture, regardless of depth
            const batch = allCategoriesData[categoryId]?.batches?.[batchId];
            if (!batch) { alert('Batch not found.'); return; }

            function findLecture(modules, targetModuleId, targetLectureId) {
                for (const mId in modules) {
                    if (mId === targetModuleId) {
                        return modules[mId].lectures?.[targetLectureId];
                    }
                    const allContent = {...(modules[mId].lectures || {}), ...(modules[mId].resources || {})};
                    for(const contentId in allContent) {
                        if(allContent[contentId].isSubModule) {
                            const found = findLecture({ [contentId]: allContent[contentId] }, targetModuleId, targetLectureId);
                            if(found) return found;
                        }
                    }
                }
                return null;
            }

            const lecture = findLecture(batch.modules, moduleId, lectureId);
            
            if (!lecture || !lecture.link) {
                alert('Video link is not available for this lecture.');
                return;
            }

            const videoId = getVideoUniqueId(categoryId, batchId, moduleId, lectureId);

            window.showView('player-view', { categoryId, batchId, moduleId, lectureId, lectureData: lecture, videoId });
            setupPlayer(lecture, videoId);
        };

        async function setupPlayer(lecture, videoId) {
            if (plyrInstance) {
                plyrInstance.destroy();
                plyrInstance = null;
            }
            
            const playerView = document.getElementById('player-view');
            const mainVideoSrc = DOMPurify.sanitize(lecture.link);
            const lectureName = DOMPurify.sanitize(lecture.name);

            const currentState = navigationStack[navigationStack.length - 1];
            const { categoryId, batchId } = currentState.context;
            const batch = allCategoriesData[categoryId]?.batches?.[batchId];

            const posterUrl = DOMPurify.sanitize(
                lecture.thumbnail ||
                (batch && batch.defaultLectureThumbnail) || 
                window.siteConfig.defaultLectureThumbnail
            );

            playerView.querySelector('#card-video-title').textContent = lectureName;
            playerView.querySelector('#download-video-btn').href = mainVideoSrc;
            playerView.querySelector('#telegram-channel-btn').href = window.siteConfig.telegramChannelLink || '#';
            playerView.querySelector('#player-logo-link').href = window.siteConfig.telegramChannelLink || '#';

            const videoSizeElement = playerView.querySelector('#video-size');
            videoSizeElement.textContent = 'Fetching...';
            try {
                const response = await fetch(mainVideoSrc, { method: 'HEAD' });
                const size = response.headers.get('content-length');
                videoSizeElement.textContent = size ? (size / Math.pow(1024, 2)).toFixed(2) + ' MB' : 'N/A';
            } catch (error) {
                videoSizeElement.textContent = 'N/A';
            }

            plyrInstance = new Plyr('#video-player', {
                controls: ['play-large', 'rewind', 'play', 'fast-forward', 'progress', 'current-time', 'duration', 'mute', 'volume', 'settings', 'pip', 'fullscreen']
            });

            const floatingText = playerView.querySelector('#floating-text');

            plyrInstance.source = { 
                type: 'video', 
                sources: [{ 
                    src: mainVideoSrc, 
                    type: 'video/mp4' 
                }],
                poster: 'https://i.postimg.cc/g0SZDWf0/Picsart-25-07-10-18-44-20-355.jpg'
            };
            
            plyrInstance.on('ready', event => {
                const container = event.detail.plyr.elements.container;
                if (container) {
                    container.appendChild(playerView.querySelector('.player-logo'));
                    container.appendChild(floatingText);
                }
            });

            plyrInstance.on('playing', () => {
                if (floatingText) floatingText.style.display = 'block'; 
            });
            plyrInstance.on('pause', () => { 
                if (floatingText) floatingText.style.display = 'none'; 
            });
            
            const likeBtn = document.getElementById('like-btn');
            const likeCountSpan = document.getElementById('like-count');
            const likeIcon = likeBtn.querySelector('i');

            const likeCountRef = dbRef(rtdb, `video_likes/${videoId}/count`);
            const userLikeRef = dbRef(rtdb, `video_likes/${videoId}/users/${currentUserId}`);

            let isLiked = false;
            const userLikeSnapshot = await get(userLikeRef);
            if (userLikeSnapshot.exists()) {
                isLiked = true;
                likeIcon.classList.replace('bi-heart', 'bi-heart-fill');
                likeBtn.classList.add('liked');
            } else {
                likeIcon.classList.replace('bi-heart-fill', 'bi-heart');
                likeBtn.classList.remove('liked');
            }
            localStorage.setItem(`liked_${videoId}`, JSON.stringify(isLiked));

            onValue(likeCountRef, (snapshot) => {
                const count = snapshot.val() || 0;
                likeCountSpan.textContent = count;
            });
            
            likeBtn.onclick = () => {
                isLiked = !isLiked;
                
                runTransaction(likeCountRef, (currentCount) => {
                    return isLiked ? (currentCount || 0) + 1 : (currentCount || 0) - 1;
                });
                
                if (isLiked) {
                    set(userLikeRef, true);
                    likeIcon.classList.replace('bi-heart', 'bi-heart-fill');
                    likeBtn.classList.add('liked');
                } else {
                    set(userLikeRef, null);
                    likeIcon.classList.replace('bi-heart-fill', 'bi-heart');
                    likeBtn.classList.remove('liked');
                }
                localStorage.setItem(`liked_${videoId}`, JSON.stringify(isLiked));
            };
            
            document.getElementById('comment-btn').onclick = () => alert('Comment feature is coming soon!');
            document.getElementById('bookmark-btn').onclick = () => alert('Bookmark feature is coming soon!');
        }

        window.DOMPurify = DOMPurify;
    </script>
</body>
</html>


